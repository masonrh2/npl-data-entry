<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPL Data Entry</title>
    <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
    <?!= include('css')?>
  </head>
  <body onload="doOnload()" style="margin: 1em;">
    <div class="header" style="display: block; padding: 1em; overflow: auto;">
      <img src="https://drive.google.com/uc?id=1JLX7vfDnqgYd_OrgPNtvj1sqV8n4ANpd"/>
      <h1>NPL Data Entry</h1>
    </div>
    <div id="timestamp" style="display: none; margin-bottom: 1em;">
      <p style="display: inline;"></p><button style="margin-left: 1em" onclick="updateDatabase()">Refresh Database</button>
    </div>
    <div id="loadingDatabase" style="display: none;">Loading Database...</div>
    <div id="submittingData" style="display: none;">Submitting Data...</div>
    <div id="sectionSelection" class="hideWhenLoading" style="display: none;">
      <button onclick="loadFiberLoading()">Fiber Loading</button>
      <button onclick="loadTungsten()">Tungsten</button>
      <button onclick="loadEpoxy()">Epoxy</button>
      <button onclick="loadDensity()">Density</button>
      <button onclick="loadPictureTests()">LT and NL</button>
      <button onclick="loadShipment()">Shipment</button>
      <section style="display: inline-block; margin-top: 1em;">
        <form action="javascript:onLogBlock()" style="display: none;">
          <label>log block: </label><input type="text" id="logBlockInput">
          <button id="logBlockButton">submit</button>
        </form>
		  </section>
    </div>
    <section id="fiberLoadingSection" class="dataEntrySection hideWhenLoading" style="display: none;">
      <h1>Fiber Loading Data Entry</h1>
      <button onclick="sectionReturn()">Back</button>
      <button onclick="generalSubmitData(fiberLoadingSettings)">SUBMIT</button><br>
      <form action="javascript:" onsubmit="batchInput(this, 'inputStatus')" style="margin-top: 1em; display: block;">
        <label style="font-weight: bold; width: 120px; display: inline-block;">Status: </label>
          <input type="text" style="width: 80px;" value="1">
        <button style="margin-left: 1em">Submit</button>
      </form>
      <form action="javascript:" onsubmit="batchInput(this, 'inputTester')" style="margin-top: 1em; display: block;">
        <label style="font-weight: bold; width: 120px; display: inline-block;">Fiber Loader: </label>
          <input type="text" style="width: 80px;">
        <button style="margin-left: 1em">Submit</button>
      </form>
      <div id="fiberLoadingGridTable" class="grid"></div>
      <form action="javascript:" onsubmit="addRows(this)" style="margin-top: 1em; display: block;">
        <input type="number" min="0" value="8" style="width: 40px;">
        <button style="margin-left: 1em">Add Rows</button>
      </form>
    </section>
    <section id="tungstenSection" class="dataEntrySection hideWhenLoading" style="display: none;">
      <h1>Tungsten Data Entry</h1>
      <button onclick="sectionReturn()">Back</button>
      <button onclick="generalSubmitData(tungstenSettings)">SUBMIT</button><br>
      <form action="javascript:" onsubmit="batchInput(this, 'inputStatus')" style="margin-top: 1em; display: block;">
        <label style="font-weight: bold; width: 120px; display: inline-block;">Status: </label>
          <input type="text" style="width: 80px;" value="2">
        <button style="margin-left: 1em">Submit</button>
      </form>
      <form action="javascript:" onsubmit="batchInput(this, 'inputPowder')" style="margin-top: 1em; display: block;">
        <label style="font-weight: bold; width: 120px; display: inline-block;">Powder: </label>
          <input type="text" style="width: 80px;" value="HCS">
        <button style="margin-left: 1em">Submit</button>
      </form>
      <form action="javascript:" onsubmit="batchInput(this, 'inputBucket')" style="margin-top: 1em; display: block;">
        <label style="font-weight: bold; width: 120px; display: inline-block;">Bucket #: </label>
          <input type="text" style="width: 80px;" value="HCS-">
        <button style="margin-left: 1em">Submit</button>
      </form>
      <form action="javascript:" onsubmit="batchInput(this, 'inputDate')" style="margin-top: 1em; display: block;">
        <label style="font-weight: bold; width: 120px; display: inline-block;">Date: </label>
          <input type="text" class="batchDateUS" style="width: 80px;">
        <button style="margin-left: 1em">Submit</button>
      </form>
      <form action="javascript:" onsubmit="batchInput(this, 'inputFiller')" style="margin-top: 1em; display: block;">
        <label style="font-weight: bold; width: 120px; display: inline-block;">Filler Initials: </label>
          <input type="text" style="width: 80px;">
        <button style="margin-left: 1em">Submit</button>
      </form>
      <div id="tungstenGridTable" class="grid"></div>
      <form action="javascript:" onsubmit="addRows(this)" style="margin-top: 1em; display: block;">
        <input type="number" min="0" value="14" style="width: 40px;">
        <button style="margin-left: 1em">Add Rows</button>
      </form>
    </section>
    <section id="epoxySection" class="dataEntrySection hideWhenLoading" style="display: none;">
      <h1>Epoxy Data Entry</h1>
      <button onclick="sectionReturn()">Back</button>
      <button onclick="generalSubmitData(epoxySettings)">SUBMIT</button><br>
      <form action="javascript:" onsubmit="batchInput(this, 'inputStatus')" style="margin-top: 1em; display: block;">
        <label style="font-weight: bold; width: 120px; display: inline-block;">Status: </label>
          <input type="text" style="width: 80px;" value="3">
        <button style="margin-left: 1em">Submit</button>
      </form>
      <form action="javascript:" onsubmit="batchInput(this, 'inputBatch')" style="margin-top: 1em; display: block;">
        <label style="font-weight: bold; width: 120px; display: inline-block;">Epoxy Batch: </label>
          <input type="text" style="width: 80px;">
        <button style="margin-left: 1em">Submit</button>
      </form>
      <form action="javascript:" onsubmit="batchInput(this, 'inputResinMass')" style="margin-top: 1em; display: block;">
        <label style="font-weight: bold; width: 120px; display: inline-block;">Resin Mass: </label>
          <input type="text" style="width: 80px;" value="110">
        <button style="margin-left: 1em">Submit</button>
      </form>
      <form action="javascript:" onsubmit="batchInput(this, 'inputHardenerMass')" style="margin-top: 1em; display: block;">
        <label style="font-weight: bold; width: 120px; display: inline-block;">Hardener Mass: </label>
          <input type="text" style="width: 80px;" value="25">
        <button style="margin-left: 1em">Submit</button>
      </form>
      <form action="javascript:" onsubmit="batchInput(this, 'inputPottingNotes')" style="margin-top: 1em; display: block;">
        <label style="font-weight: bold; width: 120px; display: inline-block;">Potting Notes: </label>
          <input type="text" style="width: 80px;" value="d40g">
        <button style="margin-left: 1em">Submit</button>
      </form>
      <form action="javascript:" onsubmit="batchInput(this, 'inputDate')" style="margin-top: 1em; display: block;">
        <label style="font-weight: bold; width: 120px; display: inline-block;">Date: </label>
          <input type="text" class="batchDateUS" style="width: 80px;">
        <button style="margin-left: 1em">Submit</button>
      </form>
      <form action="javascript:" onsubmit="batchInput(this, 'inputPreparer')" style="margin-top: 1em; display: block;">
        <label style="font-weight: bold; width: 120px; display: inline-block;">Preparer Initials: </label>
          <input type="text" style="width: 80px;">
        <button style="margin-left: 1em">Submit</button>
      </form>
      <div id="epoxyGridTable" class="grid"></div>
      <form action="javascript:" onsubmit="addRows(this)" style="margin-top: 1em; display: block;">
        <input type="number" min="0" value="8" style="width: 40px;">
        <button style="margin-left: 1em">Add Rows</button>
      </form>
    </section>
    <section id="densitySection" class="dataEntrySection hideWhenLoading" style="display: none;">
      <h1>Density Data Entry</h1>
      <button onclick="sectionReturn()">Back</button>
      <button onclick="generalSubmitData(densitySettings)">SUBMIT</button><br>
      <form action="javascript:" onsubmit="batchInput(this, 'inputStatus')" style="margin-top: 1em; display: block;">
        <label style="font-weight: bold; width: 120px; display: inline-block;">Status: </label>
          <input type="text" style="width: 80px;" value="5">
        <button style="margin-left: 1em">Submit</button>
      </form>
      <form action="javascript:" onsubmit="batchInput(this, 'inputDate')" style="margin-top: 1em; display: block;">
        <label style="font-weight: bold; width: 120px; display: inline-block;">Date: </label>
          <input type="text" class="batchDate" style="width: 80px;">
        <button style="margin-left: 1em">Submit</button>
      </form>
      <form action="javascript:" onsubmit="batchInput(this, 'inputTester')" style="margin-top: 1em; display: block;">
        <label style="font-weight: bold; width: 120px; display: inline-block;">Tester Initials: </label>
          <input type="text" style="width: 80px;">
        <button style="margin-left: 1em">Submit</button>
      </form>
      <div id="densityGridTable" class="grid"></div>
      <form action="javascript:" onsubmit="addRows(this)" style="margin-top: 1em; display: block;">
        <input type="number" min="0" value="8" style="width: 40px;">
        <button style="margin-left: 1em">Add Rows</button>
      </form>
    </section>
    <section id="pictureTestsSection" class="dataEntrySection hideWhenLoading" style="display: none;">
      <h1>LT and NL Data Entry</h1>
      <button onclick="sectionReturn()">Back</button>
      <button onclick="generalSubmitData(pictureTestsSettings)">SUBMIT</button><br>
      <form action="javascript:" onsubmit="batchInput(this, 'inputMissingRow')" style="margin-top: 1em; display: block;">
        <label style="font-weight: bold; width: 120px; display: inline-block;">Missing Row?: </label>
          <input type="text" value="N" style="width: 80px;">
        <button style="margin-left: 1em">Submit</button>
      </form>
      <form action="javascript:" onsubmit="batchInput(this, 'input13Holes')" style="margin-top: 1em; display: block;">
        <label style="font-weight: bold; width: 120px; display: inline-block;">13 Holes?: </label>
          <input type="text" value="N" style="width: 80px;">
        <button style="margin-left: 1em">Submit</button>
      </form>
      <form action="javascript:" onsubmit="batchInput(this, 'inputLTTester')" style="margin-top: 1em; display: block;">
        <label style="font-weight: bold; width: 120px; display: inline-block;">LT Tester: </label>
          <input type="text" style="width: 80px;">
        <button style="margin-left: 1em">Submit</button>
      </form>
      <form action="javascript:" onsubmit="batchInput(this, 'inputLTChecker')" style="margin-top: 1em; display: block;">
        <label style="font-weight: bold; width: 120px; display: inline-block;">LT Checked By: </label>
          <input type="text" style="width: 80px;">
        <button style="margin-left: 1em">Submit</button>
      </form>
      <form action="javascript:" onsubmit="batchInput(this, 'inputNLDate')" style="margin-top: 1em; display: block;">
        <label style="font-weight: bold; width: 120px; display: inline-block;">NL Date: </label>
          <input type="text" class="batchDate" style="width: 80px;">
        <button style="margin-left: 1em">Submit</button>
      </form>
      <form action="javascript:" onsubmit="batchInput(this, 'inputNLTester')" style="margin-top: 1em; display: block;">
        <label style="font-weight: bold; width: 120px; display: inline-block;">NL Tester: </label>
          <input type="text" style="width: 80px;">
        <button style="margin-left: 1em">Submit</button>
      </form>
      <form action="javascript:" onsubmit="batchInput(this, 'inputNLChecker')" style="margin-top: 1em; display: block;">
        <label style="font-weight: bold; width: 120px; display: inline-block;">NL Checked By: </label>
          <input type="text" style="width: 80px;">
        <button style="margin-left: 1em">Submit</button>
      </form>
      <div id="pictureTestsGridTable" class="grid"></div>
      <form action="javascript:" onsubmit="addRows(this)" style="margin-top: 1em; display: block;">
        <input type="number" min="0" value="8" style="width: 40px;">
        <button style="margin-left: 1em">Add Rows</button>
      </form>
    </section>
    <section id="shipmentSection" class="dataEntrySection hideWhenLoading" style="display: none;">
      <h1>Shipment Data Entry</h1>
      <button onclick="sectionReturn()">Back</button>
      <button onclick="generalSubmitData(shipmentSettings)">SUBMIT</button><br>
      <form action="javascript:" onsubmit="batchInput(this, 'inputStatus')" style="margin-top: 1em; display: block;">
        <label style="font-weight: bold; width: 120px; display: inline-block;">Status: </label>
          <input type="text" style="width: 80px;" value="7">
        <button style="margin-left: 1em">Submit</button>
      </form>
      <form action="javascript:" onsubmit="batchInput(this, 'inputShipment')" style="margin-top: 1em; display: block;">
        <label style="font-weight: bold; width: 120px; display: inline-block;">Shipment: </label>
          <input type="text" style="width: 80px;">
        <button style="margin-left: 1em">Submit</button>
      </form>
      <form action="javascript:" onsubmit="batchInput(this, 'inputShipmentDate')" style="margin-top: 1em; display: block;">
        <label style="font-weight: bold; width: 120px; display: inline-block;">Shipment Date: </label>
          <input type="text" class= "batchDateUS" style="width: 80px;">
        <button style="margin-left: 1em">Submit</button>
      </form>
      <div id="shipmentGridTable" class="grid"></div>
      <form action="javascript:" onsubmit="addRows(this)" style="margin-top: 1em; display: block;">
        <input type="number" min="0" value="24" style="width: 40px;">
        <button style="margin-left: 1em">Add Rows</button>
      </form>
    </section>
  </body>
  <script>
    /* global google */
    /* eslint no-undef: "error" */
    // HELPER FUNCTIONS
    function dataPresent (data) {
      return (data != null && data !== '' && data !== '#NUM!' && data !== '#DIV/0!' && data !== 'NaN')
    }
    function to2digits (string) {
      if (string.length < 2) {
        return '0' + string
      } else {
        return string
      }
    }
    function dateToYYYYMMDD (date) {
      const y = date.getFullYear().toString()
      let m = (date.getMonth() + 1).toString()
      let d = date.getDate().toString()
      if (m.length === 1) { m = '0' + m }
      if (d.length === 1) { d = '0' + d }
      return parseInt(y + m + d)
    }
    function dateToUS (date) {
      const m = (date.getMonth() + 1).toString()
      const d = (date.getDate()).toString()
      const y = (date.getFullYear()).toString()
      return m + '/' + d + '/' + y
    }
    /**
      * calculates the volume of a block
      * @param {Number[]} dimensions The dimensions of the block (in) as [l,bt,bb,bh,st,sb,sh]
      * @return {Number} The volume of the block (mL)
      */
    function getVolume (dimensions) {
      const l = dimensions[0]
      const bt = dimensions[1]
      const bb = dimensions[2]
      const bh = dimensions[3]
      const st = dimensions[4]
      const sb = dimensions[5]
      const sh = dimensions[6]
      return 16.39 * l * (1 / 2) * (((bt + bb) * bh / 2) + ((st + sb) * sh / 2))
    }
    /**
      * @param {Number}
      * @return {String}
      */
    function columnToLetter (column) {
      let temp = ''
      let letter = ''
      while (column > 0) {
        temp = (column - 1) % 26
        letter = String.fromCharCode(temp + 65) + letter
        column = (column - temp - 1) / 26
      }
      return letter
    }
    /**
      * @param {String}
      * @return {Number} the (one-based) column index
      */
    function letterToColumn (letter) {
      let column = 0
      const length = letter.length
      for (let i = 0; i < length; i++) {
        column += (letter.charCodeAt(i) - 64) * Math.pow(26, length - i - 1)
      }
      return column
    }
    // CONSTANTS
    // store the ZERO-BASED index for each column
    const columns = {
      dbn: 0,
      block: 2,
      status: 3,
      shipment: 4,
      shipmentDate: 5,
      comment: 6,
      sector: 7,
      powder: 14,
      bucket: 15,
      moldSeries: 16,
      emptyMoldMass: 17,
      filledMoldMass: 18,
      tungstenMass: 19,
      fiberLoader: 20,
      tungstenFillingDate: 21,
      tungstenFiller: 22,
      epoxyBatch: 23,
      resinMass: 24,
      hardenerMass: 25,
      pottingNotes: 26,
      epoxyFillingTime: 27,
      epoxyFillingDate: 28,
      epoxyPreparer: 29,
      machiningDate: 31,
      l: 33,
      bt: 34,
      bb: 35,
      bh: 36,
      st: 37,
      sb: 38,
      sh: 39,
      volume: 40,
      dimensionTester: 41,
      mass: 42,
      massTester: 43,
      density: 44,
      densityDate: 45,
      goodEnd: 47,
      fiberPercentage: 49,
      tower1: 55,
      tower2: 56,
      tower3: 57,
      tower4: 58,
      missingRow: 59,
      thirteenHoles: 60,
      lightTransTester: 63,
      lightTransDate: 64,
      scintillation: 65,
      scintRatio: 67,
      scintDate: 69,
      natLightDate: 70,
      natLightTester: 71,
      densityCheckedBy: 73,
      lightTransCheckedBy: 74,
      natLightCheckedBy: 75,
      pregrade: 80
    }
    // stores the expected dimensions for each block type
    // BL      L       BT      BB      BH      ST      SB      SH
    const dimensionsMap = new Map([
      [123, [5.5000, 2.0850, 2.0850, 1.9890, 1.8150, 1.8150, 1.9890]],
      [4, [5.4460, 2.0850, 2.0820, 2.2740, 1.8180, 1.8150, 1.9900]],
      [5, [5.3500, 2.0850, 2.0760, 2.2630, 1.8230, 1.8150, 1.9900]],
      [6, [5.2700, 2.0850, 2.0710, 2.2530, 1.8280, 1.8150, 1.9900]],
      [7, [5.2050, 2.0850, 2.0650, 2.2430, 1.8320, 1.8150, 1.9900]],
      [8, [5.1550, 2.0850, 2.0600, 2.2340, 1.8370, 1.8150, 1.9890]],
      [9, [5.1180, 2.0850, 2.0560, 2.2250, 1.8410, 1.8150, 1.9890]],
      [10, [5.0940, 2.0850, 2.0510, 2.2160, 1.8460, 1.8150, 1.9890]],
      [11, [5.0820, 2.0850, 2.0470, 2.2080, 1.8500, 1.8150, 1.9890]],
      [12, [5.0810, 2.0850, 2.0420, 2.2010, 1.8530, 1.8150, 1.9890]],
      [13, [5.0900, 2.0850, 2.0390, 2.1930, 1.8570, 1.8150, 1.9890]],
      [14, [5.1100, 2.0850, 2.0350, 2.1860, 1.8600, 1.8150, 1.9890]],
      [15, [5.1390, 2.0850, 2.0320, 2.1800, 1.8640, 1.8150, 1.9890]],
      [16, [5.1770, 2.0850, 2.0280, 2.1740, 1.8670, 1.8150, 1.9890]],
      [17, [5.2240, 2.0850, 2.0250, 2.1680, 1.8700, 1.8150, 1.9890]],
      [18, [5.2790, 2.0850, 2.0230, 2.1620, 1.8720, 1.8150, 1.9890]],
      [19, [5.3420, 2.0850, 2.0200, 2.1570, 1.8750, 1.8150, 1.9890]],
      [20, [5.4120, 2.0850, 2.0180, 2.1520, 1.8770, 1.8150, 1.9890]],
      [21, [5.4890, 2.0850, 2.0150, 2.1470, 1.8790, 1.8150, 1.9890]],
      [22, [5.5720, 2.0850, 2.0130, 2.1420, 1.8810, 1.8150, 1.9890]],
      [23, [5.6620, 2.0850, 2.0120, 2.1380, 1.8830, 1.8150, 1.9890]],
      [24, [5.7580, 2.0850, 2.0100, 2.1330, 1.8850, 1.8150, 1.9890]]
    ])
    // CLASS DEFINITIONS
    class Block {
      constructor (array, sheet, row, index) {
        this.sheet = sheet
        this.row = row
        this.index = index
        this.dbn = array[0]
        this.block = parseInt(array[2])
        this.status = array[3]
        this.shipment = (!dataPresent(array[4]) || parseInt(array[4]) === 0) ? null : parseInt(array[4])
        this.shipmentDate = (!dataPresent(array[5])) ? null : array[5]
        this.powder = (!dataPresent(array[14])) ? null : array[14]
        this.bucket = (!dataPresent(array[15])) ? null : array[15]
        this.moldSeries = (!dataPresent(array[16])) ? null : array[16]
        this.emptyMoldMass = (!dataPresent(array[17])) ? null : parseInt(array[17])
        this.filledMoldMass = (!dataPresent(array[18])) ? null : parseInt(array[18])
        this.tungstenMass = (!dataPresent(array[19]) || parseInt(array[19]) === 0) ? null : parseInt(array[19])
        this.fiberLoader = (!dataPresent(array[20])) ? null : array[20]
        this.tungstenFillingDate = (!dataPresent(array[21])) ? null : array[21]
        this.tungstenFiller = (!dataPresent(array[22])) ? null : array[22]
        this.epoxyBatch = (!dataPresent(array[23])) ? null : parseInt(array[23])
        this.resinMass = (!dataPresent(array[24])) ? null : parseInt(array[24])
        this.hardenerMass = (!dataPresent(array[25])) ? null : parseInt(array[25])
        this.pottingNotes = (!dataPresent(array[26])) ? null : array[26]
        this.epoxyFillingTime = (!dataPresent(array[27])) ? null : parseFloat(array[27])
        this.epoxyFillingDate = (!dataPresent(array[28])) ? null : array[28]
        this.epoxyPreparer = (!dataPresent(array[29])) ? null : array[29]
        this.l = (!dataPresent(array[33])) ? null : parseFloat(array[33])
        this.bt = (!dataPresent(array[34])) ? null : parseFloat(array[34])
        this.bb = (!dataPresent(array[35])) ? null : parseFloat(array[35])
        this.bh = (!dataPresent(array[36])) ? null : parseFloat(array[36])
        this.st = (!dataPresent(array[37])) ? null : parseFloat(array[37])
        this.sb = (!dataPresent(array[38])) ? null : parseFloat(array[38])
        this.sh = (!dataPresent(array[39])) ? null : parseFloat(array[39])
        this.volume = (!dataPresent(array[40]) || parseInt(array[40]) === 0) ? null : parseFloat(array[40])
        this.dimensionTester = (!dataPresent(array[41])) ? null : array[41]
        this.mass = (!dataPresent(array[42])) ? null : parseInt(array[42])
        this.massTester = (!dataPresent(array[43])) ? null : array[43]
        this.density = (!dataPresent(array[44])) ? null : parseFloat(array[44])
        this.densityDate = (!dataPresent(array[45])) ? null : parseInt(array[45])
        this.fiberPercentage = (!dataPresent(array[49]) || parseInt(array[49]) === 0) ? null : parseFloat(array[49])
        this.tower1 = (!dataPresent(array[55])) ? null : parseFloat(array[55])
        this.tower2 = (!dataPresent(array[56])) ? null : parseFloat(array[56])
        this.tower3 = (!dataPresent(array[57])) ? null : parseFloat(array[57])
        this.tower4 = (!dataPresent(array[58])) ? null : parseFloat(array[58])
        this.missingRow = (!dataPresent(array[59]) || (array[59] !== 'Y' && array[59] !== 'N')) ? null : array[59]
        this.thirteenHoles = (!dataPresent(array[60]) || (array[60] !== 'Y' && array[60] !== 'N')) ? null : array[60]
        this.lightTransTester = (!dataPresent(array[63])) ? null : array[63]
        this.lightTransDate = (!dataPresent(array[64])) ? null : array[64]
        this.lightTransDateActual = (!dataPresent(array[64]) || isNaN(parseInt(removeSuffix(array[64])))) ? null : parseInt(removeSuffix(array[64]))
        this.scintillation = (!dataPresent(array[65])) ? null : parseFloat(array[65])
        this.scintRatio = (!dataPresent(array[67])) ? null : parseFloat(array[67])
        this.scintTester = (!dataPresent(array[68])) ? null : array[68]
        this.scintDate = (!dataPresent(array[69])) ? null : array[69]
        this.scintDateActual = (!dataPresent(array[69]) || isNaN(parseInt(removeSuffix(array[69])))) ? null : parseInt(removeSuffix(array[69]))
        this.natLightDate = (!dataPresent(array[70])) ? null : parseInt(array[70])
        this.natLightTester = (!dataPresent(array[71])) ? null : array[71]
        this.retouch = array[72]
        this.densityCheckedBy = dataPresent(array[73]) ? array[73] : null
        this.densityChecked = this.densityCheckedBy != null
        this.lightTransCheckedBy = dataPresent(array[74]) ? array[74] : null
        this.lightTransChecked = this.lightTransCheckedBy != null
        this.natLightCheckedBy = dataPresent(array[75]) ? array[75] : null
        this.natLightChecked = this.natLightCheckedBy != null
        this.pregrade = array[80]
        //other calculations
        const densityCompleteVars = [this.volume, this.mass, this.massTester, this.l, this.bt, this.bb, this.bh, this.st, this.sb, this.sh]
        this.densityComplete = densityCompleteVars.every((value) => value != null)
        this.lightTransComplete = this.fiberPercentage != null && this.missingRow != null && this.thirteenHoles != null && this.lightTransTester != null
        this.scintComplete = this.scintillation != null && this.scintRatio != null
        this.natLightComplete = this.natLightDate != null && this.natLightTester != null
        this.testsComplete = this.densityComplete && this.lightTransComplete && this.scintComplete && this.natLightComplete
        this.testsChecked = this.densityChecked && this.lightTransChecked && this.natLightChecked
      }

      deviations () {
        const tols = [this.l, this.bt, this.bb, this.bh, this.st, this.sb, this.sh]
        if (tols.every((value) => value != null)) {
          const devs = []
          tols.forEach(function (value, index) { devs[index] = value - dimensionsMap.get(this.block)[index] })
          return devs
        } else {
          return null
        }
      }

      testGrades () {
        if (this.sheet === 0) {
          const devs = this.deviations()
          const devGrades = new Array(7)
          if (devs == null) {
            devGrades.fill(notStartedGrade)
          } else {
            for (let i = 0; i < devs.length; i++) {
              if (i === 0) {
                devGrades[0] = (devs[0] == null) ? notStartedGrade : grade_dL(devs[0])
              } else {
                devGrades[i] = (devs[i] == null) ? notStartedGrade : grade_otherDev(devs[i])
              }
            }
          }
          const densityValuesToGrade = [
            ((this.density == null) ? notStartedGrade : grade_density(this.density)),
            ...devGrades
          ]
          const densityGrade = Math.max(...densityValuesToGrade)
          return {
            density: densityGrade,
            tolerances: devGrades
          }
        } else {
          return null
        }
      }
    }
    class BlocksCollection {
      constructor (array) {
        this.array = array
        // console.log('new blocks collection with array length ' + array.length)
      }

      getBlockByIndex (index) {
        return this.array[index]
      }
    
      getBlockByLocation (sheet, row) {
        let index
        // shame we can't use a binary search here (string DBNs are not sorted), but it really doesn't take that long
        this.array.forEach(function (block, _index, array) {
          if (block.sheet === sheet && block.row === row) {
            index = _index
          }
        })
        if (index != null) { return this.array[index] }
      }

      getBlockByStringDBN (stringDBN) {
        let index
        // shame we can't use a binary search here (string DBNs are not sorted), but it really doesn't take that long
        this.array.forEach(function (block, _index, array) {
          if (stringDBN === block.dbn) {
            index = _index
          }
        })
        if (index != null) { return this.array[index] }
      }
    
      updateBlock (rowData, sheet, row) {
        const dbn = rowData[0]
        const block = this.getBlockByStringDBN(dbn)
        if (block != null) {
          const i = block.index
          this.array[i] = new Block(rowData, sheet, row, i)
        }
      }

      getBlocksNeedingRetouch (retouchStatus) {
        const blocks = []
        const devNames = ['L', 'BT', 'BB', 'BH', 'ST', 'SB', 'SH']
        const allowedStatuses = ['5', '5a', '5b', '5c']
        this.array.forEach(function (block) {
          if (block.deviations() != null && block.retouch === retouchStatus && allowedStatuses.includes(block.status)) {
            const retouchDevs = []
            block.deviations().forEach(function (dev, index) {
              if (index === 0) {
                if (grade_dL(dev) === fGrade && dev > 0) {
                  retouchDevs.push([devNames[index], dev])
                }
              } else if (grade_otherDev(dev) === fGrade && dev > 0) {
                retouchDevs.push([devNames[index], '+' + dev.toFixed(4)])
              }
            })
            if (retouchDevs.length > 0) {
              blocks.push([block, retouchDevs])
            }
          }
        })
        return blocks
      }
    }
    function removeSuffix (string) {
      return string.split(/[.-]/)[0]
    }
    const dimNames = ['l', 'bt', 'bb', 'bh', 'st', 'sb', 'sh']
    function getDevGrade (dim, dimName, blockType) {
      const index = dimNames.indexOf(dimName)
      const expected = dimensionsMap.get(blockType)[index]
      const dev = dim - expected
      const gradingFunction = dimName === 'l' ? grade_dL : grade_otherDev
      return gradingFunction(dev)
    }
    // COLORS (HEX)
    const red = '#800000'
    const blue = '#0080ff'
    const greenish = '#00ffbf'
    const purple = '#aa00ff'
    const magenta = '#ff00ff'
    const orange = '#e66000'
    const green = '#008000'
    const black = '#000000'
    const grey = '#ababab'
    // GRADING
    // larger grade values are worse
    const notStartedGrade = 0
    const aGrade = 1
    const bGrade = 2
    const cGrade = 3
    const fGrade = 4
    const testColors = [grey, green, orange, blue, red]
    const testSymbols = ['-', 'A', 'B', 'C', 'F']
    const checkColors = { false: grey, true: green }
    function grade_pregrade (grade) {
      if (grade === '5a') {
        return aGrade
      } else if (grade === '5b') {
        return bGrade
      } else if (grade === '5c') {
        return cGrade
      } else if (grade === '8') {
        return fGrade
      } else {
        return null
      }
    }
    function grade_density (density) {
      if (density > 8.8) {
        return aGrade
      } else if (density >= 8.7) {
        return bGrade
      } else if (density >= 8.4) {
        return cGrade
      } else {
        return fGrade
      }
    }
    function grade_dL (dL) {
      if (Math.abs(dL) <= 0.03) {
        return aGrade
      } else if (dL <= 0.05 && dL >= -0.1) {
        return bGrade
      } else {
        return fGrade
      }
    }
    function grade_otherDev (dev) {
      if (Math.abs(dev) <= 0.02) {
        return aGrade
      } else if (dev <= 0.02 && dev >= -0.04) {
        return bGrade
      } else {
        return fGrade
      }
    }
    function grade_missingRow (x) {
      if (x) {
        return fGrade
      } else {
        return aGrade
      }
    }
    function grade_thirteenHoles (x) {
      if (x) {
        return fGrade
      } else {
        return aGrade
      }
    }
    function grade_fiberPercentage (percent) {
      if (percent >= 98) {
        return aGrade
      } else if (percent >= 97) {
        return bGrade
      } else if (percent >= 96) {
        return cGrade
      } else {
        return fGrade
      }
    }
    function grade_tower (percent) {
      if (percent >= 96) {
        return aGrade
      } else if (percent >= 94) {
        return bGrade
      } else if (percent >= 92) {
        return cGrade
      } else {
        return fGrade
      }
    }
    function grade_scintRatio (ratio) {
      if (ratio >= 0.7) {
        return aGrade
      } else {
        return fGrade
      }
    }
    // BASIC (CLIENT-SIDE) DATA VALIDATION
    const validate = {
      shipment: validNumber,
      shipmentDate: validUSDate,
      powder: function (data) {
        if (data === 'HCS') {
          return {
            valid: true,
            msg: null
          }
        } else {
          return {
            valid: false,
            msg: "expected 'HCS'"
          }
        }
      }, // handled by database data validation
      bucket: function (data) {
        const split = data.split('-')
        if (split.length !== 2) {
          return {
            valid: false,
            msg: "expected '-'"
          }
        } else {
          const pre = split[0]
          const suf = split[1]
          if (pre !== 'HCS') {
            return {
              valid: false,
              msg: "expected bucket to begin with 'HCS'"
            }
          } else if (suf === '' || isNaN(suf)) {
            return {
              valid: false,
              msg: "expected number after 'HCS'"
            }
          } else {
            return {
              valid: true,
              msg: null
            }
          }
        }
      }, // handled by database data validation
      // moldSeries: function (data) {return true}, // handled by database data validation
      emptyMoldMass: validNumber,
      filledMoldMass: validNumber,
      fiberLoader: validInitials,
      tungstenFillingDate: validUSDate,
      tungstenFiller: validInitials, // handled by database data validation
      epoxyBatch: validNumber, // handled by database data validation
      resinMass: validNumber, // handled by database data validation
      hardenerMass: validNumber, // handled by database data validation
      pottingNotes: function (data) {
        if (data === 'd40g') {
          return {
            valid: true,
            msg: null
          }
        } else {
          return {
            valid: false,
            msg: "expected 'd40g'"
          }
        }
      },
      epoxyFillingTime: validNumber,
      epoxyFillingDate: validUSDate,
      epoxyPreparer: validInitials, // handled by database data validation
      l: validNumber,
      bt: validNumber,
      bb: validNumber,
      bh: validNumber,
      st: validNumber,
      sb: validNumber,
      sh: validNumber,
      dimensionTester: validInitials, // should always be the same as mass tester, which is handled by database data validation
      mass: validNumber,
      massTester: validInitials, // handled by database data validation
      densityDate: validYYYYMMDD
    }
    function validNumber (str) {
      if (str !== '' && !isNaN(str)) {
        return {
          valid: true,
          msg: null
        }
      } else {
        return {
          valid: false,
          msg: 'expected a number'
        }
      }
    }
    function validUSDate (str) {
      const split = str.split('/')
      if (split.length !== 3) {
        return {
          valid: false,
          msg: "expected two /'s in US date"
        }
      }
      let m = split[0]
      let d = split[1]
      let y = split[2]
      if (isNaN(y) || isNaN(m) || isNaN(d)) {
        return {
          valid: false,
          msg: "expected numbers between /'s"
        }
      }
      y = Number(y)
      m = Number(m)
      d = Number(d)
      if (y > 2000 && m < 13 && d < 32) {
        return {
          valid: true,
          msg: null
        }
      } else {
        return {
          valid: false,
          msg: 'expected a valid US Date (month/day/year)'
        }
      }
    }
    function validInitials (str) {
      if (str.length === 2) {
        return {
          valid: true,
          msg: null
        }
      } else {
        return {
          valid: false,
          msg: 'expected initials (two characters)'
        }
      }
    }
    function validYYYYMMDD (str) {
      if (str.length !== 8) {
        return {
          valid: false,
          msg: 'expected 8 characters (YYYYMMDD)'
        }
      }
      let y = str.substr(0, 4)
      let m = str.substr(4, 2)
      let d = str.substr(6, 2)
      if (isNaN(y) || isNaN(m) || isNaN(d)) {
        return {
          valid: false,
          msg: 'expected only numberic characters'
        }
      }
      y = Number(y)
      m = Number(m)
      d = Number(d)
      if (y > 2000 && m < 13 && d < 32) {
        return {
          valid: true,
          msg: null
        }
      } else {
        return {
          valid: false,
          msg: 'expected a valid date (YYYYMMDD)'
        }
      }
    }
    function dbnChange (divRow, that) {
      const dbn = $(that).val()
      const block = dbn === '' ? null : blocksCollection.getBlockByStringDBN(dbn)
      const findBlockSpan = $(divRow).find("span[data-name='block']")
      const blockSpan = findBlockSpan.length > 0 ? findBlockSpan.eq(0) : null
      const findStatusSpan = $(divRow).find("span[data-name='status']")
      const statusSpan = findStatusSpan.length === 1 ? findStatusSpan.eq(0) : null
      const findStatusInput = $(divRow).find("input[data-name='status']")
      const statusInput = findStatusInput.length === 1 ? findStatusInput.eq(0) : null
      const findFiberSpan = $(divRow).find("span[data-name='fiberPercentage']")
      const fiberSpan = findFiberSpan.length === 1 ? findFiberSpan.eq(0) : null
      // locate table to find table name to use map.....quite convoluted..
      const tableName = $(that).parents('div.grid').attr('id')
      if (block != null) {
        $(divRow).find('input.updateDBvlaue').each(function (index) {
          const element = this
          element.disabled = false
          element.style.backgroundColor = 'transparent'
          $(element).keyup()
        })
        if (blockSpan != null) { blockSpan.text(block.block) }
        if (statusSpan != null) { updateStatusSpan(statusSpan, block.status, tableNameToStatusConfig.get(tableName)) }
        if (statusInput != null) {
          const element = statusInput.get(0)
          element.disabled = false
          element.style.backgroundColor = 'transparent'
          // $(element).keyup()
        }
        if (fiberSpan !== null) { fiberSpan.text(block.fiberPercentage) }
      } else {
        $(divRow).find('input.updateDBvlaue').each(function (index) {
          const element = this
          element.value = ''
          element.placeholder = ''
          element.disabled = true
          element.style.border = '1px solid grey'
          element.style.backgroundColor = '#eee'
        })
        if (blockSpan != null) { blockSpan.text('-') }
        if (statusSpan != null) { updateStatusSpan(statusSpan, null, tableNameToStatusConfig.get(tableName)) }
        if (statusInput != null) {
          const element = statusInput.get(0)
          element.value = ''
          element.placeholder = ''
          element.disabled = true
          element.style.border = '1px solid grey'
          element.style.backgroundColor = '#eee'
        }
        if (fiberSpan !== null) { fiberSpan.text('-') }
      }
    }
    function updateThisDBValue (divRow, element, toFixed) {
      const dbn = $(divRow).find("input[data-name='dbn']").val()
      const block = dbn === '' ? null : blocksCollection.getBlockByStringDBN(dbn)
      let placeholder = block[element.getAttribute('data-name')]
      if (placeholder !== null && toFixed > 0) { placeholder = placeholder.toFixed(toFixed) }
      updateTextInput(element, placeholder)
    }
    function updateTextInput (inputElement, placeholder) {
      if (placeholder != null) {
        inputElement.placeholder = placeholder
        // to avoid bad string comparison such as '5' == '5.0000', we cast
        // to number when the number is numeric and not '' (for comparison only)
        const inputValue = inputElement.value !== '' && !isNaN(inputElement.value) ? Number(inputElement.value) : inputElement.value
        const placeholderValue = placeholder !== '' && !isNaN(placeholder) ? Number(placeholder) : placeholder
        if (inputElement.value === '') {
          inputElement.style.border = '2px solid orange'
          // we knowinglly use a castful comparison to avoid tedium
        } else if (inputValue == placeholderValue) {
          inputElement.style.border = '2px solid green'
        } else {
          inputElement.style.border = '2px solid red'
          // console.log('found that ' + inputElement.value + ' !=' + placeholder)
        }
      } else {
        inputElement.placeholder = ''
        if (inputElement.value === '') {
          inputElement.style.border = '1px solid grey'
        } else {
          inputElement.style.border = '2px solid green'
        }
      }
    }
    function updateStatusSpan (span, curStatus) {
      const tableName = $(span).parents('div.grid').attr('id')
      const config = tableNameToStatusConfig.get(tableName)
      if (curStatus === null) {
        // reset
        span.text('-').css('font-weight', 'bold').css('color', 'grey')
      } else {
        // change style accordingly
        let color
        if (config.goodFromStatus.some(function (element) { return element == curStatus })) {
          color = 'green'
        } else if (config.errorFromStatus.some(function (element) { return element == curStatus })) {
          color = 'red'
        } else {
          color = 'orange'
        }
        span.text(curStatus).css('font-weight', 'bold').css('color', color)
      }
    }
    function updateStatusInput (that) {
      const input = $(that)
      const tableName = input.parents('div.grid').attr('id')
      const config = tableNameToStatusConfig.get(tableName)
      const val = input.val()
      if (val === '') { // this is the input that will eventually need to be checked for errors
        // reset
        input.css('border', '1px solid grey')
      } else {
        // change style accordingly
        let color
        if (config.goodToStatus.some(function (element) { return element == val })) {
          color = 'green'
        } else if (config.errorToStatus.some(function (element) { return element == val })) {
          color = 'red'
        } else {
          color = 'orange'
        }
        input.css('border', '2px solid ' + color)
      }
    }
    function dimensionKeyup (divRow, that) {
      const lInput = $(divRow).find("input[data-name='l']")
      const lInputValue = lInput.val()
      const lInputPlaceholder = lInput.attr('placeholder')
      const lGradeSpan = lInput.parent('div.gridData').find('span.grade')
      const btInput = $(divRow).find("input[data-name='bt']")
      const btInputValue = btInput.val()
      const btInputPlaceholder = btInput.attr('placeholder')
      const btGradeSpan = btInput.parent('div.gridData').find('span.grade')
      const bbInput = $(divRow).find("input[data-name='bb']")
      const bbInputValue = bbInput.val()
      const bbInputPlaceholder = bbInput.attr('placeholder')
      const bbGradeSpan = bbInput.parent('div.gridData').find('span.grade')
      const bhInput = $(divRow).find("input[data-name='bh']")
      const bhInputValue = bhInput.val()
      const bhInputPlaceholder = bhInput.attr('placeholder')
      const bhGradeSpan = bhInput.parent('div.gridData').find('span.grade')
      const stInput = $(divRow).find("input[data-name='st']")
      const stInputValue = stInput.val()
      const stInputPlaceholder = stInput.attr('placeholder')
      const stGradeSpan = stInput.parent('div.gridData').find('span.grade')
      const sbInput = $(divRow).find("input[data-name='sb']")
      const sbInputValue = sbInput.val()
      const sbInputPlaceholder = sbInput.attr('placeholder')
      const sbGradeSpan = sbInput.parent('div.gridData').find('span.grade')
      const shInput = $(divRow).find("input[data-name='sh']")
      const shInputValue = shInput.val()
      const shInputPlaceholder = shInput.attr('placeholder')
      const shGradeSpan = shInput.parent('div.gridData').find('span.grade')

      const volumeSpan = $(divRow).find("span[data-name='volume']")
      const densitySpan = $(divRow).find("span[data-name='density']")
      const densityGradeSpan = densitySpan.parent('div.gridData').find('span.grade')

      const inputDimensions = [
        lInputValue !== '' && !isNaN(lInputValue) ? Number(lInputValue) : null,
        btInputValue !== '' && !isNaN(btInputValue) ? Number(btInputValue) : null,
        bbInputValue !== '' && !isNaN(bbInputValue) ? Number(bbInputValue) : null,
        bhInputValue !== '' && !isNaN(bhInputValue) ? Number(bhInputValue) : null,
        stInputValue !== '' && !isNaN(stInputValue) ? Number(stInputValue) : null,
        sbInputValue !== '' && !isNaN(sbInputValue) ? Number(sbInputValue) : null,
        shInputValue !== '' && !isNaN(shInputValue) ? Number(shInputValue) : null
      ]
      // console.log(inputDimensions)
      const blockDimensions = [
        lInputPlaceholder !== '' && !isNaN(lInputPlaceholder) ? Number(lInputPlaceholder) : null,
        btInputPlaceholder !== '' && !isNaN(btInputPlaceholder) ? Number(btInputPlaceholder) : null,
        bbInputPlaceholder !== '' && !isNaN(bbInputPlaceholder) ? Number(bbInputPlaceholder) : null,
        bhInputPlaceholder !== '' && !isNaN(bhInputPlaceholder) ? Number(bhInputPlaceholder) : null,
        stInputPlaceholder !== '' && !isNaN(stInputPlaceholder) ? Number(stInputPlaceholder) : null,
        sbInputPlaceholder !== '' && !isNaN(sbInputPlaceholder) ? Number(sbInputPlaceholder) : null,
        shInputPlaceholder !== '' && !isNaN(shInputPlaceholder) ? Number(shInputPlaceholder) : null
      ]
      // console.log(blockDimensions)
      const useDimensions = []
      for (let i = 0; i < inputDimensions.length; i++) {
        useDimensions[i] = inputDimensions[i] === null ? blockDimensions[i] : inputDimensions[i]
        // console.log('input was ' + inputDimensions[i] + ', placeholder was ' + blockDimensions[i] + ', chose ' + useDimensions[i])
      }
      const gradeSpans = [lGradeSpan, btGradeSpan, bbGradeSpan, bhGradeSpan, stGradeSpan, sbGradeSpan, shGradeSpan]
      const blockText = $(divRow).find("span[data-name='block']").text()
      // console.log(blockText)
      const block = blockText !== '' && !isNaN(blockText) ? Number(blockText) : null
      if (block !== null) {
        const useDevs = []
        const expectedDimensions = dimensionsMap.get(block)
        for (let i = 0; i < useDimensions.length; i++) {
          useDevs.push(useDimensions[i] - expectedDimensions[i])
        }
        for (let i = 0; i < gradeSpans.length; i++) {
          if (i === 0) {
            setGradeSpan(gradeSpans[i], grade_dL(useDevs[i]))
          } else {
            setGradeSpan(gradeSpans[i], grade_otherDev(useDevs[i]))
          }
        }
      } else {
        for (let i = 0; i < gradeSpans.length; i++) {
          setGradeSpan(gradeSpans[i], notStartedGrade)
        }
      }
      if (useDimensions.every((element) => element !== null)) {
        const vol = getVolume(useDimensions)
        volumeSpan.text(vol.toFixed(1))
        const inputMass = $(divRow).find("input[data-name='mass']")
        // console.log(inputMass)
        let mass
        if (inputMass.val() !== '' && !isNaN(inputMass.val())) {
          mass = Number(inputMass.val())
        } else if (inputMass.attr('placeholder') !== '' && !isNaN(inputMass.attr('placeholder'))) {
          mass = inputMass.attr('placeholder')
        } else {
          mass = null
        }
        let density
        if (mass != null) { density = mass / vol }
        if (density != null) {
          densitySpan.text(density.toFixed(2))
          setGradeSpan(densityGradeSpan, grade_density(density))
        } else {
          densitySpan.text('-')
          setGradeSpan(densityGradeSpan, notStartedGrade)
        }
      } else {
        volumeSpan.text('-')
        densitySpan.text('-')
        setGradeSpan(densityGradeSpan, notStartedGrade)
      }
    }
    function setGradeSpan (jQuery, grade) {
      jQuery.text(testSymbols[grade]).css('color', testColors[grade]).css('font-weight', 'bold')
    }
    // error: dark red, bold
    // good: dark green, bold
    // else, warning: orange, bold
    // don't forget return to defult when no block is found (reset input border, add bold grey hyphen to span?)
    const fiberLoadingStatusConfig = {
      errorFromStatus: [7],
      goodFromStatus: [0],
      errorToStatus: [],
      goodToStatus: [1]
    }
    const tungstenStatusConfig = {
      errorFromStatus: [0, 7],
      goodFromStatus: [1],
      errorToStatus: [],
      goodToStatus: [2]
    }
    const epoxyStatusConfig = {
      errorFromStatus: [0, 7],
      goodFromStatus: [2],
      errorToStatus: [],
      goodToStatus: [3]
    }
    const densityStatusConfig = {
      errorFromStatus: [0, 7],
      goodFromStatus: [3, 4],
      errorToStatus: [],
      goodToStatus: [5]
    }
    const testStatusConfig = {
      errorFromStatus: [0, 1, 2, 7],
      goodFromStatus: [5]
    }
    const shipmentStatusConfig = {
      errorFromStatus: [0, 1, 2, 3, 4],
      goodFromStatus: [5, 6],
      errorToStatus: [],
      goodToStatus: [7]
    }
    const tableNameToStatusConfig = new Map([
      ['fiberLoadingGridTable', fiberLoadingStatusConfig],
      ['tungstenGridTable', tungstenStatusConfig],
      ['epoxyGridTable', epoxyStatusConfig],
      ['densityGridTable', densityStatusConfig],
      ['pictureTestsGridTable', testStatusConfig],
      ['shipmentGridTable', shipmentStatusConfig]
    ])
    const colWidths = {
      dbn: '40px',
      block: '40px',
      status: '70px',
      initials: '50px',
      dim: '75px',
      date: '70px',
      usDate: '80px'
    }
    // TABLE CONFIGURATIONS
    const fiberLoadingConfig = [
      {
        headerName: 'DBN',
        colWidth: colWidths.dbn,
        DOMs: [
          {
            options: {
              type: 'input',
              classes: [],
              attributes: [['data-name', 'dbn'], ['type', 'text']],
              style: [['width', '100%']]
            },
            update: {
              numeric: false,
              fn: function (divRow, that) {
                dbnChange(divRow, that)
              }
            }
          }
        ]
      },
      {
        headerName: 'Block',
        colWidth: colWidths.block,
        DOMs: [
          {
            options: {
              type: 'span',
              classes: [],
              attributes: [['data-name', 'block']],
              style: [['width', '100%']]
            },
            update: {
              numeric: true,
              fn: null
            }
          }
        ]
      },
      {
        headerName: 'Status',
        colWidth: colWidths.status,
        DOMs: [
          { // CURRENT STATUS
            options: {
              type: 'span',
              classes: [],
              attributes: [['data-name', 'status']],
              style: [['width', 'calc(30% - 10px)'], ['margin-left', '5px']]
            },
            update: {
              numeric: false,
              fn: null
            }
          },
          { // (ARROW)
            options: {
              type: 'span',
              classes: ['static'],
              attributes: [],
              style: [['margin-left', '5px'], ['width', 'calc(20% - 10px)']],
              innerHTML: '→'
            },
            update: {
              numeric: false,
              fn: null
            }
          },
          { // INPUT STATUS
            options: {
              type: 'input',
              classes: ['inputStatus', 'submit'],
              attributes: [['data-name', 'status'], ['type', 'text']],
              style: [['margin-left', '5px'], ['width', 'calc(50% - 10px)']]
            },
            update: {
              numeric: false,
              fn: function (divRow, that) {
                // do some checks and change style accordingly
                // also include errors (probably during inital checks (client-side))
                updateStatusInput(that)
              }
            }
          }
        ]
      },
      {
        headerName: 'Mold Number',
        colWidth: '60px',
        DOMs: [
          {
            options: {
              type: 'input',
              classes: ['updateDBvlaue', 'submit'],
              attributes: [['data-name', 'moldSeries'], ['type', 'text']],
              style: [['width', '100%']]
            },
            update: {
              numeric: false,
              fn: function (divRow, that) {
                updateThisDBValue(divRow, that, -1)
              }
            }
          }
        ]
      },
      {
        headerName: 'Fiber Loader',
        colWidth: colWidths.initials,
        DOMs: [
          {
            options: {
              type: 'input',
              classes: ['updateDBvlaue', 'submit', 'inputTester'],
              attributes: [['data-name', 'fiberLoader'], ['type', 'text']],
              style: [['width', '100%']]
            },
            update: {
              numeric: false,
              fn: function (divRow, that) {
                updateThisDBValue(divRow, that, -1)
              }
            }
          }
        ]
      }
    ]
    const tungstenConfig = [
      {
        headerName: 'DBN',
        colWidth: colWidths.dbn,
        DOMs: [
          {
            options: {
              type: 'input',
              classes: [],
              attributes: [['data-name', 'dbn'], ['type', 'text']],
              style: [['width', '100%']]
            },
            update: {
              numeric: false,
              fn: function (divRow, that) {
                dbnChange(divRow, that)
              }
            }
          }
        ]
      },
      {
        headerName: 'Block',
        colWidth: colWidths.block,
        DOMs: [
          {
            options: {
              type: 'span',
              classes: [],
              attributes: [['data-name', 'block']],
              style: [['width', '100%']]
            },
            update: {
              numeric: true,
              fn: null
            }
          }
        ]
      },
      {
        headerName: 'Status',
        colWidth: colWidths.status,
        DOMs: [
          { // CURRENT STATUS
            options: {
              type: 'span',
              classes: [],
              attributes: [['data-name', 'status']],
              style: [['width', 'calc(30% - 10px)'], ['margin-left', '5px']]
            },
            update: {
              numeric: false,
              fn: null
            }
          },
          { // (ARROW)
            options: {
              type: 'span',
              classes: ['static'],
              attributes: [],
              style: [['margin-left', '5px'], ['width', 'calc(20% - 10px)']],
              innerHTML: '→'
            },
            update: {
              numeric: false,
              fn: null
            }
          },
          { // INPUT STATUS
            options: {
              type: 'input',
              classes: ['inputStatus', 'submit'],
              attributes: [['data-name', 'status'], ['type', 'text']],
              style: [['margin-left', '5px'], ['width', 'calc(50% - 10px)']]
            },
            update: {
              numeric: false,
              fn: function (divRow, that) {
                // do some checks and change style accordingly
                // also include errors (probably during inital checks (client-side))
                updateStatusInput(that)
              }
            }
          }
        ]
      },
      {
        headerName: 'Powder',
        colWidth: '60px',
        DOMs: [
          {
            options: {
              type: 'input',
              classes: ['inputPowder', 'updateDBvlaue', 'submit'],
              attributes: [['data-name', 'powder'], ['type', 'text']],
              style: [['width', '100%']]
            },
            update: {
              numeric: false,
              fn: function (divRow, that) {
                updateThisDBValue(divRow, that, -1)
              }
            }
          }
        ]
      },
      {
        headerName: 'Bucket #',
        colWidth: '60px',
        DOMs: [
          {
            options: {
              type: 'input',
              classes: ['inputBucket', 'updateDBvlaue', 'submit'],
              attributes: [['data-name', 'bucket'], ['type', 'text']],
              style: [['width', '100%']]
            },
            update: {
              numeric: false,
              fn: function (divRow, that) {
                updateThisDBValue(divRow, that, -1)
              }
            }
          }
        ]
      },
      {
        headerName: 'Empty Mass (g)',
        colWidth: '60px',
        DOMs: [
          {
            options: {
              type: 'input',
              classes: ['updateDBvlaue', 'submit'],
              attributes: [['data-name', 'emptyMoldMass'], ['type', 'text']],
              style: [['width', '100%']]
            },
            update: {
              numeric: true,
              fn: function (divRow, that) {
                updateThisDBValue(divRow, that, -1)
              }
            }
          }
        ]
      },
      {
        headerName: 'Filled Mass (g)',
        colWidth: '60px',
        DOMs: [
          {
            options: {
              type: 'input',
              classes: ['updateDBvlaue', 'submit'],
              attributes: [['data-name', 'filledMoldMass'], ['type', 'text']],
              style: [['width', '100%']]
            },
            update: {
              numeric: true,
              fn: function (divRow, that) {
                updateThisDBValue(divRow, that, -1)
              }
            }
          }
        ]
      },
      {
        headerName: 'Filling Date',
        colWidth: colWidths.date,
        DOMs: [
          {
            options: {
              type: 'input',
              classes: ['inputDate', 'updateDBvlaue', 'submit'],
              attributes: [['data-name', 'tungstenFillingDate'], ['type', 'text']],
              style: [['width', '100%']]
            },
            update: {
              numeric: false,
              fn: function (divRow, that) {
                updateThisDBValue(divRow, that, -1)
              }
            }
          }
        ]
      },
      {
        headerName: 'Filler Initials',
        colWidth: colWidths.initials,
        DOMs: [
          {
            options: {
              type: 'input',
              classes: ['inputFiller', 'updateDBvlaue', 'submit'],
              attributes: [['data-name', 'tungstenFiller'], ['type', 'text']],
              style: [['width', '100%']]
            },
            update: {
              numeric: false,
              fn: function (divRow, that) {
                updateThisDBValue(divRow, that, -1)
              }
            }
          }
        ]
      }
    ]
    const epoxyConfig = [
      {
        headerName: 'DBN',
        colWidth: colWidths.dbn,
        DOMs: [
          {
            options: {
              type: 'input',
              classes: [],
              attributes: [['data-name', 'dbn'], ['type', 'text']],
              style: [['width', '100%']]
            },
            update: {
              numeric: false,
              fn: function (divRow, that) {
                dbnChange(divRow, that)
              }
            }
          }
        ]
      },
      {
        headerName: 'Block',
        colWidth: colWidths.block,
        DOMs: [
          {
            options: {
              type: 'span',
              classes: [],
              attributes: [['data-name', 'block']],
              style: [['width', '100%']]
            },
            update: {
              numeric: true,
              fn: null
            }
          }
        ]
      },
      {
        headerName: 'Status',
        colWidth: colWidths.status,
        DOMs: [
          { // CURRENT STATUS
            options: {
              type: 'span',
              classes: [],
              attributes: [['data-name', 'status']],
              style: [['width', 'calc(30% - 10px)'], ['margin-left', '5px']]
            },
            update: {
              numeric: false,
              fn: null
            }
          },
          { // (ARROW)
            options: {
              type: 'span',
              classes: ['static'],
              attributes: [],
              style: [['margin-left', '5px'], ['width', 'calc(20% - 10px)']],
              innerHTML: '→'
            },
            update: {
              numeric: false,
              fn: null
            }
          },
          { // INPUT STATUS
            options: {
              type: 'input',
              classes: ['inputStatus', 'submit'],
              attributes: [['data-name', 'status'], ['type', 'text']],
              style: [['margin-left', '5px'], ['width', 'calc(50% - 10px)']]
            },
            update: {
              numeric: false,
              fn: function (divRow, that) {
                // do some checks and change style accordingly
                // also include errors (probably during inital checks (client-side))
                updateStatusInput(that)
              }
            }
          }
        ]
      },
      {
        headerName: 'Batch',
        colWidth: '60px',
        DOMs: [
          {
            options: {
              type: 'input',
              classes: ['inputBatch', 'updateDBvlaue', 'submit'],
              attributes: [['data-name', 'epoxyBatch'], ['type', 'text']],
              style: [['width', '100%']]
            },
            update: {
              numeric: false,
              fn: function (divRow, that) {
                updateThisDBValue(divRow, that, -1)
              }
            }
          }
        ]
      },
      {
        headerName: 'Resin Mass (g)',
        colWidth: '60px',
        DOMs: [
          {
            options: {
              type: 'input',
              classes: ['inputResinMass', 'updateDBvlaue', 'submit'],
              attributes: [['data-name', 'resinMass'], ['type', 'text']],
              style: [['width', '100%']]
            },
            update: {
              numeric: true,
              fn: function (divRow, that) {
                updateThisDBValue(divRow, that, -1)
              }
            }
          }
        ]
      },
      {
        headerName: 'Hardener Mass (g)',
        colWidth: '60px',
        DOMs: [
          {
            options: {
              type: 'input',
              classes: ['inputHardenerMass', 'updateDBvlaue', 'submit'],
              attributes: [['data-name', 'hardenerMass'], ['type', 'text']],
              style: [['width', '100%']]
            },
            update: {
              numeric: true,
              fn: function (divRow, that) {
                updateThisDBValue(divRow, that, -1)
              }
            }
          }
        ]
      },
      {
        headerName: 'Potting Notes',
        colWidth: '60px',
        DOMs: [
          {
            options: {
              type: 'input',
              classes: ['inputPottingNotes', 'updateDBvlaue', 'submit'],
              attributes: [['data-name', 'pottingNotes'], ['type', 'text']],
              style: [['width', '100%']]
            },
            update: {
              numeric: false,
              fn: function (divRow, that) {
                updateThisDBValue(divRow, that, -1)
              }
            }
          }
        ]
      },
      {
        headerName: 'Filling Time (min)',
        colWidth: '60px',
        DOMs: [
          {
            options: {
              type: 'input',
              classes: ['updateDBvlaue', 'submit'],
              attributes: [['data-name', 'epoxyFillingTime'], ['type', 'text']],
              style: [['width', '100%']]
            },
            update: {
              numeric: true,
              fn: function (divRow, that) {
                updateThisDBValue(divRow, that, -1)
              }
            }
          }
        ]
      },
      {
        headerName: 'Filling Date',
        colWidth: colWidths.date,
        DOMs: [
          {
            options: {
              type: 'input',
              classes: ['inputDate', 'updateDBvlaue', 'submit'],
              attributes: [['data-name', 'epoxyFillingDate'], ['type', 'text']],
              style: [['width', '100%']]
            },
            update: {
              numeric: false,
              fn: function (divRow, that) {
                updateThisDBValue(divRow, that, -1)
              }
            }
          }
        ]
      },
      {
        headerName: 'Preparer Initials',
        colWidth: '60px',
        DOMs: [
          {
            options: {
              type: 'input',
              classes: ['inputPreparer', 'updateDBvlaue', 'submit'],
              attributes: [['data-name', 'epoxyPreparer'], ['type', 'text']],
              style: [['width', '100%']]
            },
            update: {
              numeric: false,
              fn: function (divRow, that) {
                updateThisDBValue(divRow, that, -1)
              }
            }
          }
        ]
      }
    ]
    const densityConfig = [
      {
        headerName: 'DBN',
        colWidth: colWidths.dbn,
        DOMs: [
          {
            options: {
              type: 'input',
              classes: [],
              attributes: [['data-name', 'dbn'], ['type', 'text']],
              style: [['width', '100%']]
            },
            update: {
              numeric: false,
              fn: function (divRow, that) {
                dbnChange(divRow, that)
                dimensionKeyup(divRow)
              }
            }
          }
        ]
      },
      {
        headerName: 'Block',
        colWidth: colWidths.block,
        DOMs: [
          {
            options: {
              type: 'span',
              classes: [],
              attributes: [['data-name', 'block']],
              style: [['width', '100%']]
            },
            update: {
              numeric: true,
              fn: null
            }
          }
        ]
      },
      {
        headerName: 'Status',
        colWidth: colWidths.status,
        DOMs: [
          { // CURRENT STATUS
            options: {
              type: 'span',
              classes: [],
              attributes: [['data-name', 'status']],
              style: [['width', 'calc(30% - 10px)'], ['margin-left', '5px']]
            },
            update: {
              numeric: false,
              fn: null
            }
          },
          { // (ARROW)
            options: {
              type: 'span',
              classes: ['static'],
              attributes: [],
              style: [['margin-left', '5px'], ['width', 'calc(20% - 10px)']],
              innerHTML: '→'
            },
            update: {
              numeric: false,
              fn: null
            }
          },
          { // INPUT STATUS
            options: {
              type: 'input',
              classes: ['inputStatus', 'submit'],
              attributes: [['data-name', 'status'], ['type', 'text']],
              style: [['margin-left', '5px'], ['width', 'calc(50% - 10px)']]
            },
            update: {
              numeric: false,
              fn: function (divRow, that) {
                // do some checks and change style accordingly
                // also include errors (probably during inital checks (client-side))
                updateStatusInput(that)
              }
            }
          }
        ]
      },
      {
        headerName: 'L (in)',
        colWidth: colWidths.dim,
        DOMs: [
          {
            options: {
              type: 'input',
              classes: ['updateDBvlaue', 'submit'],
              attributes: [['data-name', 'l'], ['type', 'text']],
              style: [['width', 'calc(80% - 5px)']]
            },
            update: {
              numeric: true,
              fn: function (divRow, that) {
                updateThisDBValue(divRow, that, 4)
                dimensionKeyup(divRow)
              }
            }
          },
          {
            options: {
              type: 'span',
              classes: ['grade'],
              attributes: [],
              style: [['width', 'calc(20% - 5px)'], ['margin-left', '5px']]
            },
            update: {
              numeric: true,
              fn: null
            }
          }
        ]
      },
      {
        headerName: 'BT (in)',
        colWidth: colWidths.dim,
        DOMs: [
          {
            options: {
              type: 'input',
              classes: ['updateDBvlaue', 'submit'],
              attributes: [['data-name', 'bt'], ['type', 'text']],
              style: [['width', 'calc(80% - 5px)']]
            },
            update: {
              numeric: true,
              fn: function (divRow, that) {
                updateThisDBValue(divRow, that, 4)
                dimensionKeyup(divRow)
              }
            }
          },
          {
            options: {
              type: 'span',
              classes: ['grade'],
              attributes: [],
              style: [['width', 'calc(20% - 5px)'], ['margin-left', '5px']]
            },
            update: {
              numeric: true,
              fn: null
            }
          }
        ]
      },
      {
        headerName: 'BB (in)',
        colWidth: colWidths.dim,
        DOMs: [
          {
            options: {
              type: 'input',
              classes: ['updateDBvlaue', 'submit'],
              attributes: [['data-name', 'bb'], ['type', 'text']],
              style: [['width', 'calc(80% - 5px)']]
            },
            update: {
              numeric: true,
              fn: function (divRow, that) {
                updateThisDBValue(divRow, that, 4)
                dimensionKeyup(divRow)
              }
            }
          },
          {
            options: {
              type: 'span',
              classes: ['grade'],
              attributes: [],
              style: [['width', 'calc(20% - 5px)'], ['margin-left', '5px']]
            },
            update: {
              numeric: true,
              fn: null
            }
          }
        ]
      },
      {
        headerName: 'BH (in)',
        colWidth: colWidths.dim,
        DOMs: [
          {
            options: {
              type: 'input',
              classes: ['updateDBvlaue', 'submit'],
              attributes: [['data-name', 'bh'], ['type', 'text']],
              style: [['width', 'calc(80% - 5px)']]
            },
            update: {
              numeric: true,
              fn: function (divRow, that) {
                updateThisDBValue(divRow, that, 4)
                dimensionKeyup(divRow)
              }
            }
          },
          {
            options: {
              type: 'span',
              classes: ['grade'],
              attributes: [],
              style: [['width', 'calc(20% - 5px)'], ['margin-left', '5px']]
            },
            update: {
              numeric: true,
              fn: null
            }
          }
        ]
      },
      {
        headerName: 'ST (in)',
        colWidth: colWidths.dim,
        DOMs: [
          {
            options: {
              type: 'input',
              classes: ['updateDBvlaue', 'submit'],
              attributes: [['data-name', 'st'], ['type', 'text']],
              style: [['width', 'calc(80% - 5px)']]
            },
            update: {
              numeric: true,
              fn: function (divRow, that) {
                updateThisDBValue(divRow, that, 4)
                dimensionKeyup(divRow)
              }
            }
          },
          {
            options: {
              type: 'span',
              classes: ['grade'],
              attributes: [],
              style: [['width', 'calc(20% - 5px)'], ['margin-left', '5px']]
            },
            update: {
              numeric: true,
              fn: null
            }
          }
        ]
      },
      {
        headerName: 'SB (in)',
        colWidth: colWidths.dim,
        DOMs: [
          {
            options: {
              type: 'input',
              classes: ['updateDBvlaue', 'submit'],
              attributes: [['data-name', 'sb'], ['type', 'text']],
              style: [['width', 'calc(80% - 5px)']]
            },
            update: {
              numeric: true,
              fn: function (divRow, that) {
                updateThisDBValue(divRow, that, 4)
                dimensionKeyup(divRow)
              }
            }
          },
          {
            options: {
              type: 'span',
              classes: ['grade'],
              attributes: [],
              style: [['width', 'calc(20% - 5px)'], ['margin-left', '5px']]
            },
            update: {
              numeric: true,
              fn: null
            }
          }
        ]
      },
      {
        headerName: 'SH (in)',
        colWidth: colWidths.dim,
        DOMs: [
          {
            options: {
              type: 'input',
              classes: ['updateDBvlaue', 'submit'],
              attributes: [['data-name', 'sh'], ['type', 'text']],
              style: [['width', 'calc(80% - 5px)']]
            },
            update: {
              numeric: true,
              fn: function (divRow, that) {
                updateThisDBValue(divRow, that, 4)
                dimensionKeyup(divRow)
              }
            }
          },
          {
            options: {
              type: 'span',
              classes: ['grade'],
              attributes: [],
              style: [['width', 'calc(20% - 5px)'], ['margin-left', '5px']]
            },
            update: {
              numeric: true,
              fn: null
            }
          }
        ]
      },
      {
        headerName: 'Volume (mL)',
        colWidth: '50px',
        DOMs: [
          {
            options: {
              type: 'span',
              classes: [],
              attributes: [['data-name', 'volume']],
              style: [['width', '100%']]
            },
            update: {
              numeric: true,
              fn: null
            }
          }
        ]
      },
      {
        headerName: 'Tester Initials',
        colWidth: colWidths.initials,
        DOMs: [
          {
            options: {
              type: 'input',
              classes: ['inputTester', 'updateDBvlaue', 'submit'],
              attributes: [['data-name', 'dimensionTester'], ['type', 'text']],
              style: [['width', '100%']]
            },
            update: {
              numeric: false,
              fn: function (divRow, that) {
                updateThisDBValue(divRow, that, -1)
              }
            }
          }
        ]
      },
      {
        headerName: 'Mass (g)',
        colWidth: '45px',
        DOMs: [
          {
            options: {
              type: 'input',
              classes: ['updateDBvlaue', 'submit'],
              attributes: [['data-name', 'mass'], ['type', 'text']],
              style: [['width', '100%']]
            },
            update: {
              numeric: true,
              fn: function (divRow, that) {
                updateThisDBValue(divRow, that, -1)
                dimensionKeyup(divRow)
              }
            }
          }
        ]
      },
      {
        headerName: 'Tester Initials',
        colWidth: colWidths.initials,
        DOMs: [
          {
            options: {
              type: 'input',
              classes: ['inputTester', 'updateDBvlaue', 'submit'],
              attributes: [['data-name', 'massTester'], ['type', 'text']],
              style: [['width', '100%']]
            },
            update: {
              numeric: false,
              fn: function (divRow, that) {
                updateThisDBValue(divRow, that, -1)
              }
            }
          }
        ]
      },
      {
        headerName: 'Density (g/mL)',
        colWidth: '50px',
        DOMs: [
          {
            options: {
              type: 'span',
              classes: [],
              attributes: [['data-name', 'density']],
              style: [['width', 'calc(80% - 5px)']]
            },
            update: {
              numeric: true,
              fn: null
            }
          },
          {
            options: {
              type: 'span',
              classes: ['grade'],
              attributes: [],
              style: [['width', 'calc(20% - 5px)'], ['margin-left', '5px']]
            },
            update: {
              numeric: true,
              fn: null
            }
          }
        ]
      },
      {
        headerName: 'Date',
        colWidth: colWidths.date,
        DOMs: [
          {
            options: {
              type: 'input',
              classes: ['inputDate', 'updateDBvlaue', 'submit'],
              attributes: [['data-name', 'densityDate'], ['type', 'text']],
              style: [['width', '100%']]
            },
            update: {
              numeric: false,
              fn: function (divRow, that) {
                updateThisDBValue(divRow, that, -1)
              }
            }
          }
        ]
      }
    ]
    const pictureTestsConfig = [
      {
        headerName: 'DBN',
        colWidth: colWidths.dbn,
        DOMs: [
          {
            options: {
              type: 'input',
              classes: [],
              attributes: [['data-name', 'dbn'], ['type', 'text']],
              style: [['width', '100%']]
            },
            update: {
              numeric: false,
              fn: function (divRow, that) {
                dbnChange(divRow, that)
              }
            }
          }
        ]
      },
      {
        headerName: 'Block',
        colWidth: colWidths.block,
        DOMs: [
          {
            options: {
              type: 'span',
              classes: [],
              attributes: [['data-name', 'block']],
              style: [['width', '100%']]
            },
            update: {
              numeric: true,
              fn: null
            }
          }
        ]
      },
      {
        headerName: 'Status',
        colWidth: '40px',
        DOMs: [
          { // CURRENT STATUS
            options: {
              type: 'span',
              classes: [],
              attributes: [['data-name', 'status']],
              style: [['width', '100%']]
            },
            update: {
              numeric: false,
              fn: null
            }
          }
        ]
      },
      {
        headerName: 'Fiber (%)',
        colWidth: '50px',
        DOMs: [
          {
            options: {
              type: 'span',
              classes: [],
              attributes: [['data-name', 'fiberPercentage'], ['type', 'text']],
              style: [['width', '100%']]
            },
            update: {
              numeric: false,
              fn: null
            }
          }
        ]
      },
      {
        headerName: 'Missing Row?',
        colWidth: '50px',
        DOMs: [
          {
            options: {
              type: 'input',
              classes: ['updateDBvlaue', 'submit', 'inputMissingRow'],
              attributes: [['data-name', 'missingRow'], ['type', 'text']],
              style: [['width', '100%']]
            },
            update: {
              numeric: false,
              fn: function (divRow, that) {
                updateThisDBValue(divRow, that, -1)
              }
            }
          }
        ]
      },
      {
        headerName: '13 Holes?',
        colWidth: '50px',
        DOMs: [
          {
            options: {
              type: 'input',
              classes: ['updateDBvlaue', 'submit', 'input13Holes'],
              attributes: [['data-name', 'thirteenHoles'], ['type', 'text']],
              style: [['width', '100%']]
            },
            update: {
              numeric: false,
              fn: function (divRow, that) {
                updateThisDBValue(divRow, that, -1)
              }
            }
          }
        ]
      },
      {
        headerName: 'LT Tester',
        colWidth: '60px',
        DOMs: [
          {
            options: {
              type: 'input',
              classes: ['updateDBvlaue', 'submit', 'inputLTTester'],
              attributes: [['data-name', 'lightTransTester'], ['type', 'text']],
              style: [['width', '100%']]
            },
            update: {
              numeric: false,
              fn: function (divRow, that) {
                updateThisDBValue(divRow, that, -1)
              }
            }
          }
        ]
      },
      {
        headerName: 'LT Checked By',
        colWidth: '60px',
        DOMs: [
          {
            options: {
              type: 'input',
              classes: ['updateDBvlaue', 'submit', 'inputLTChecker'],
              attributes: [['data-name', 'lightTransCheckedBy'], ['type', 'text']],
              style: [['width', '100%']]
            },
            update: {
              numeric: false,
              fn: function (divRow, that) {
                updateThisDBValue(divRow, that, -1)
              }
            }
          }
        ]
      },
      {
        headerName: 'NL Date',
        colWidth: colWidths.date,
        DOMs: [
          {
            options: {
              type: 'input',
              classes: ['updateDBvlaue', 'submit', 'inputNLDate'],
              attributes: [['data-name', 'natLightDate'], ['type', 'text']],
              style: [['width', '100%']]
            },
            update: {
              numeric: false,
              fn: function (divRow, that) {
                updateThisDBValue(divRow, that, -1)
              }
            }
          }
        ]
      },
      {
        headerName: 'NL Tester',
        colWidth: '60px',
        DOMs: [
          {
            options: {
              type: 'input',
              classes: ['updateDBvlaue', 'submit', 'inputNLTester'],
              attributes: [['data-name', 'natLightTester'], ['type', 'text']],
              style: [['width', '100%']]
            },
            update: {
              numeric: false,
              fn: function (divRow, that) {
                updateThisDBValue(divRow, that, -1)
              }
            }
          }
        ]
      },
      {
        headerName: 'NL Checked By',
        colWidth: '60px',
        DOMs: [
          {
            options: {
              type: 'input',
              classes: ['updateDBvlaue', 'submit', 'inputNLChecker'],
              attributes: [['data-name', 'natLightCheckedBy'], ['type', 'text']],
              style: [['width', '100%']]
            },
            update: {
              numeric: false,
              fn: function (divRow, that) {
                updateThisDBValue(divRow, that, -1)
              }
            }
          }
        ]
      }
    ]
    const shipmentConfig = [
      {
        headerName: 'DBN',
        colWidth: colWidths.dbn,
        DOMs: [
          {
            options: {
              type: 'input',
              classes: [],
              attributes: [['data-name', 'dbn'], ['type', 'text']],
              style: [['width', '100%']]
            },
            update: {
              numeric: false,
              fn: function (divRow, that) {
                dbnChange(divRow, that)
              }
            }
          }
        ]
      },
      {
        headerName: 'Block',
        colWidth: colWidths.block,
        DOMs: [
          {
            options: {
              type: 'span',
              classes: [],
              attributes: [['data-name', 'block']],
              style: [['width', '100%']]
            },
            update: {
              numeric: true,
              fn: null
            }
          }
        ]
      },
      {
        headerName: 'Status',
        colWidth: colWidths.status,
        DOMs: [
          { // CURRENT STATUS
            options: {
              type: 'span',
              classes: [],
              attributes: [['data-name', 'status']],
              style: [['width', 'calc(30% - 10px)'], ['margin-left', '5px']]
            },
            update: {
              numeric: false,
              fn: null
            }
          },
          { // (ARROW)
            options: {
              type: 'span',
              classes: ['static'],
              attributes: [],
              style: [['margin-left', '5px'], ['width', 'calc(20% - 10px)']],
              innerHTML: '→'
            },
            update: {
              numeric: false,
              fn: null
            }
          },
          { // INPUT STATUS
            options: {
              type: 'input',
              classes: ['inputStatus', 'submit'],
              attributes: [['data-name', 'status'], ['type', 'text']],
              style: [['margin-left', '5px'], ['width', 'calc(50% - 10px)']]
            },
            update: {
              numeric: false,
              fn: function (divRow, that) {
                // do some checks and change style accordingly
                // also include errors (probably during inital checks (client-side))
                updateStatusInput(that)
              }
            }
          }
        ]
      },
      {
        headerName: 'Shipment',
        colWidth: '60px',
        DOMs: [
          {
            options: {
              type: 'input',
              classes: ['updateDBvlaue', 'submit', 'inputShipment'],
              attributes: [['data-name', 'shipment'], ['type', 'text']],
              style: [['width', '100%']]
            },
            update: {
              numeric: false,
              fn: function (divRow, that) {
                updateThisDBValue(divRow, that, -1)
              }
            }
          }
        ]
      },
      {
        headerName: 'Shipment Date',
        colWidth: colWidths.usDate,
        DOMs: [
          {
            options: {
              type: 'input',
              classes: ['updateDBvlaue', 'submit', 'inputShipmentDate'],
              attributes: [['data-name', 'shipmentDate'], ['type', 'text']],
              style: [['width', '100%']]
            },
            update: {
              numeric: false,
              fn: function (divRow, that) {
                updateThisDBValue(divRow, that, -1)
              }
            }
          }
        ]
      }
    ]
    const fiberLoadingRows = []
    const tungstenRows = []
    const epoxyRows = []
    const densityRows = []
    const pictureTestsRows = []
    const shipmentRows = []
    const fiberLoadingSettings = {
      config: fiberLoadingConfig,
      table: $('#fiberLoadingGridTable'),
      rows: fiberLoadingRows,
      name: 'fiberLoading'
    }
    const tungstenSettings = {
      config: tungstenConfig,
      table: $('#tungstenGridTable'),
      rows: tungstenRows,
      name: 'tungsten'
    }
    const epoxySettings = {
      config: epoxyConfig,
      table: $('#epoxyGridTable'),
      rows: epoxyRows,
      name: 'epoxy'
    }
    const densitySettings = {
      config: densityConfig,
      table: $('#densityGridTable'),
      rows: densityRows,
      name: 'density'
    }
    const pictureTestsSettings = {
      config: pictureTestsConfig,
      table: $('#pictureTestsGridTable'),
      rows: pictureTestsRows,
      name: 'pictureTests'
    }
    const shipmentSettings = {
      config: shipmentConfig,
      table: $('#shipmentGridTable'),
      rows: shipmentRows,
      name: 'shipment'
    }
    const tableNameToSettings = new Map([
      ['fiberLoadingGridTable', fiberLoadingSettings],
      ['tungstenGridTable', tungstenSettings],
      ['epoxyGridTable', epoxySettings],
      ['densityGridTable', densitySettings],
      ['pictureTestsGridTable', pictureTestsSettings],
      ['shipmentGridTable', shipmentSettings]
    ])
    const allSettings = [fiberLoadingSettings, tungstenSettings, epoxySettings, densitySettings, pictureTestsSettings, shipmentSettings]
    let currentDate
    let database
    const headers = []
    const sheetNames = ['Blocks DB', 'Blocks1364DB']
    let blocksCollection
    let lastDatabaseLoad
    let reloadDatabaseTimer
    let selectedSection
    function doOnload () {
      function getDatabaseOnLoad () {
        currentDate = new Date()
        document.getElementById('loadingDatabase').style.display = 'block'
        google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).getDatabase()
        function onSuccess (gotDatabase) {
          lastDatabaseLoad = new Date()
          updateTimestamp()
          $('#timestamp').css('display', 'block')
          console.log('loaded database in ' + (Date.now() - currentDate.getTime()) / 1000 + ' s')
          database = [gotDatabase.sheet1, gotDatabase.sheet2]
          const blocks = []
          headers[0] = database[0][0]
          for (let i = 1; i < database[0].length; i++) {
            if (database[0][i][columns.block] !== '' && !isNaN(database[0][i][columns.block])) {
              blocks.push(new Block(database[0][i], 0, i + 1, blocks.length))
            }
          }
          headers[1] = database[1][0]
          for (let i = 1; i < database[1].length; i++) {
            if (database[1][i][columns.block] !== '' && !isNaN(database[1][i][columns.block])) {
              blocks.push(new Block(database[1][i], 1, i + 1, blocks.length))
            }
          }
          blocksCollection = new BlocksCollection(blocks)
          document.getElementById('loadingDatabase').style.display = 'none'
          document.getElementById('sectionSelection').style.display = 'block'
          selectedSection = 'sectionSelection'
          setupGridTables()
        }
        function onFailure (err) {
          console.error('failed to load database...retrying in 10 seconds')
          window.setTimeout(getDatabaseOnLoad, 10 * 1000)
          throw err
        }
        $('input.batchDateUS').val(dateToUS(currentDate))
        $('input.batchDate').val(dateToYYYYMMDD(currentDate))
      }
      try {
        getDatabaseOnLoad()
      } catch (err) {
        console.error('unexpected error while getting database...retrying in 10 seconds')
        window.setTimeout(getDatabaseOnLoad, 10 * 1000)
        // throw (err)
      }
    }
    function setupGridTables () {
      for (const tableSettings of allSettings) {
        addHeaders(tableSettings)
      }
      function addHeaders (tableSettings) {
        for (const columnConfig of tableSettings.config) {
          tableSettings.table.append(
            $('<div>' + columnConfig.headerName + '</div>').addClass('gridTableHeader').css('width', columnConfig.colWidth)
          )
        }
        tableSettings.table.css('grid-template-columns', 'repeat(' + tableSettings.config.length + ', auto)')
      }
    }
    function addRowByConfig (tableSettings, count) {
      const rows = tableSettings.rows
      const table = tableSettings.table
      const tableConfig = tableSettings.config
      const numRows = Math.floor(table.children('div.gridData').length / tableConfig.length)
      for (let i = 0; i < count; i++) {
        const row = []
        const rowNum = numRows + i
        for (const config of tableConfig) {
          const div = $('<div/>').addClass('gridData').attr('data-row', rowNum).css('width', config.colWidth)
          for (const dom of config.DOMs) {
            const element = $('<' + dom.options.type + '/>')
            for (const pair of dom.options.attributes) {
              element.attr(pair[0], pair[1])
            }
            for (const pair of dom.options.style) {
              element.css(pair[0], pair[1])
            }
            for (const cls of dom.options.classes) {
              element.addClass(cls)
            }
            if (dom.options.innerHTML != null) { element.html(dom.options.innerHTML) }
            if (dom.update.fn != null) { element.keyup(function () { dom.update.fn(rows[rowNum], this) }) }
            div.append(element)
          }
          row.push(div.get(0))
        }
        table.append(row)
        const rowData = table.find('[data-row="' + (numRows + i) + '"]').toArray()
        rows.push(rowData)
        $(row).find("input[data-name='dbn']").keyup()
        // console.log(row)
      }
    }
    function addRows (form) {
      const inputVal = $(form).children('input').eq(0).val()
      const tableName = $(form).parent('section').children('div.grid').eq(0).attr('id')
      const tableSettings = tableNameToSettings.get(tableName)
      addRowByConfig(tableSettings, Number(inputVal))
    }
    // this is quite an elegant function - I like it
    function batchInput (form, className) {
      const grid = $(form).parent('section').children('div.grid').eq(0)
      const inputVal = $(form).children('input').eq(0).val()
      grid.find('div.gridData > input.' + className).filter(':enabled').val(inputVal).keyup()
    }
    function loadFiberLoading() {
      document.getElementById('sectionSelection').style.display = 'none'
      document.getElementById('fiberLoadingSection').style.display = 'block'
      selectedSection = 'fiberLoadingSection'
    }
    function loadTungsten () {
      document.getElementById('sectionSelection').style.display = 'none'
      document.getElementById('tungstenSection').style.display = 'block'
      selectedSection = 'tungstenSection'
    }
    function loadEpoxy () {
      document.getElementById('sectionSelection').style.display = 'none'
      document.getElementById('epoxySection').style.display = 'block'
      selectedSection = 'epoxySection'
    }
    function loadDensity () {
      document.getElementById('sectionSelection').style.display = 'none'
      document.getElementById('densitySection').style.display = 'block'
      selectedSection = 'densitySection'
    }
    function loadPictureTests () {
      document.getElementById('sectionSelection').style.display = 'none'
      document.getElementById('pictureTestsSection').style.display = 'block'
      selectedSection = 'pictureTestsSection'
    }
    function loadShipment () {
      document.getElementById('sectionSelection').style.display = 'none'
      document.getElementById('shipmentSection').style.display = 'block'
      selectedSection = 'shipmentSection'
    }
    function sectionReturn () {
      $('.dataEntrySection').css('display', 'none')
      document.getElementById('sectionSelection').style.display = 'block'
      selectedSection = 'sectionSelection'
    }
    function onLogBlock () {
      const blockName = document.getElementById('logBlockInput').value
      const start = Date.now()
      const block = blocksCollection.getBlockByStringDBN(blockName)
      if (block != null) {
        // google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).getRowData([{sheet: block.sheet, row: block.row}])
        console.log(block)
      } else {
        console.log("unable to locate that DBN (here's where I would offer you an option to refresh the database for another opportunity to find that block)")
      }
      function onSuccess (data) {
        const blockData = data[0]
        if (blockData != null) {
          console.log('found that block in ' + (Date.now() - start) / 1000 + ' s')
          console.log(blockData)
        } else {
          console.log('unable to locate that block')
        }
      }
      function onFailure (err) {
        alert('The server encountered an uncaught error while logging block:\n' + JSON.stringify(err))
        throw err
      }
    }
    function generalSubmitData (tableSettings) {
      const blocks = []
      const values = []
      const columnNames = []
      const rows = tableSettings.rows
      for (const row of rows) {
        const stringDBN = $(row).find("input[data-name='dbn']").val()
        if (stringDBN !== '') {
          const block = blocksCollection.getBlockByStringDBN(stringDBN)
          if (block != null) {
            blocks.push(block)
            const blockValues = []
            for (let i = 0; i < tableSettings.config.length; i++) {
              const columnConfig = tableSettings.config[i]
              // iterate through DOMs
              for (let j = 0; j < columnConfig.DOMs.length; j++) {
                if (columnConfig.DOMs[j].options.classes.includes('submit')) {
                  const propertyName = columnConfig.DOMs[j].options.attributes[0][1]
                  let _set = $(row[i]).find('input.submit').val()
                  if (_set !== '') {
                    let _expected = block[propertyName]
                    if (_expected == null) { _expected = '' }
                    // cast set value to num if needed... or if it CAN be?
                    if (columnConfig.DOMs[j].update.numeric && _set !== '' && !isNaN(_set)) {
                      _set = Number(_set)
                    }
                    blockValues.push({ set: _set, expected: _expected, ignoreError: false })
                    // console.log('submitting ' + propertyName)
                  } else {
                    blockValues.push(null)
                    // console.log('NOT submitting ' + propertyName)
                  }
                  columnNames.push(propertyName)
                  break
                }
              }
            }
            values.push(blockValues)
          } else {
            console.error('unable to find DBN ' + stringDBN + ' (you could try refreshing the database?)')
          }
        }
      }
      // console.log('table name was: ' + tableSettings.name)
      submitData(blocks, columnNames, values, tableSettings.name + 'GridTable')
    }
    
    /**
     * submits data to the database
     * @param {Block[]} blocks Array of blocks
     * @param {String[]} columnNames Names of columns (which correspond to the columns in values)
     * @param {String[][]} values Values to submit to the database (row corresponds to blocks, column corresponds to columnNames)
     */
    function submitData (blocks, columnNames, values, tableName) {
      // first, organize data to send to the google script
      const data = []
      const cols = []
      for (const name of columnNames) {
        cols.push(columns[name])
      }
      for (let i = 0; i < blocks.length; i++) {
        const block = blocks[i]
        const blockData = {}
        blockData.expectedDBN = block.dbn
        blockData.sheet = block.sheet
        blockData.row = block.row
        blockData.cols = []
        blockData.values = []
        for (let j = 0; j < values[i].length; j++) {
          if (values[i][j] != null) {
            blockData.cols.push(cols[j])
            blockData.values.push(values[i][j])
          }
        }
        data.push(blockData)
      }
      // next, check if we know this data will overwrite existing data if submitted
      const overwriteWarnings = validateOverwrites(blocks, columnNames, values, tableName)
      if (overwriteWarnings.length !== 0) {
        // if there are overwrites, ask to confirm before proceeding
        showOverwriteWarnings(overwriteWarnings, blocks, columnNames, values, data, tableName)
      } else {
        // if not, proceed to perform basic data validation before sending to google script
        const basicDataValidationWarnings = validateData(blocks, columnNames, values, tableName)
        if (basicDataValidationWarnings.length !== 0) {
          showWarnings(basicDataValidationWarnings, data)
        } else {
          // submit to the google script
          $('#' + selectedSection).css('display', 'none')
          $('#submittingData').css('display', 'block')
          google.script.run.withSuccessHandler(onSubmitDataSuccess).withFailureHandler(onFailure).setBlockData(data)
        }
      }
    
      function validateOverwrites (blocks, columnNames, values, tableName) {
        const statusConfig = tableNameToStatusConfig.get(tableName)
        const warnings = []
        // console.log(values)
        for (let i = 0; i < values.length; i++) {
          const block = blocks[i]
          for (let j = 0; j < columnNames.length; j++) {
            const value = values[i][j]
            // console.log(value)
            if (columnNames[j] === 'status' && value !== null) {
              if (statusConfig.goodFromStatus.some(function (element) { return element == value.expected })) {
                continue
              } else if (statusConfig.errorFromStatus.some(function (element) { return element == value.expected })) {
                // error
                warnings.push({
                  dbn: block.dbn,
                  custom: '(ERROR) this block is status ' + value.expected
                })
              } else {
                // warning
                warnings.push({
                  dbn: block.dbn,
                  custom: '(WARNING) this block is status ' + value.expected
                })
              }
            } else if (value !== null && value.expected !== '' && value.set != value.expected) {
              warnings.push({
                set: value.set,
                prev: value.expected,
                col: columnNames[j],
                dbn: block.dbn,
                custom: null
              })
            }
          }
        }
        return warnings
      }
      function showOverwriteWarnings (overwriteWarnings, blocks, columnNames, values, data, tableName) {
        // console.log(data)
        // console.log('table name was: ' + tableName)
        let warningMsg = '(WARNING) This submission would overwrite some data in the database:\n'
        for (const warn of overwriteWarnings) {
          if (warn.custom !== null) {
            warningMsg += 'DBN ' + warn.dbn + ': ' + warn.custom + '\n'
          } else {
            warningMsg += 'DBN ' + warn.dbn + ', column "' + warn.col +
              '": (warning) changing value "' + warn.prev + '" → "' + warn.set + '"\n'
          }
        }
        warningMsg += 'Are you sure you want to submit this data to the database?'
        const bool = confirm(warningMsg)
        if (bool) {
          // overwrite was confirmed, perform basic data validation before sending to google script
          const warnings = validateData(blocks, columnNames, values, tableName)
          if (warnings.length !== 0) {
            showWarnings(warnings, data)
          } else {
            // submit to the google script
            $('#' + selectedSection).css('display', 'none')
            $('#submittingData').css('display', 'block')
            google.script.run.withSuccessHandler(onSubmitDataSuccess).withFailureHandler(onFailure).setBlockData(data)
          }
        }
      }
    
      function validateData (blocks, columnNames, values, tableName) {
        // console.log('table name was: ' + tableName)
        const statusConfig = tableNameToStatusConfig.get(tableName)
        const warnings = []
        // console.log(values)
        for (let i = 0; i < values.length; i++) {
          const block = blocks[i]
          for (let j = 0; j < columnNames.length; j++) {
            const value = values[i][j]
            // console.log(value)
            if (value != null && Object.prototype.hasOwnProperty.call(validate, columnNames[j])) {
              const validation = validate[columnNames[j]](value.set)
              if (!validation.valid) {
                warnings.push({
                  msg: validation.msg,
                  col: columnNames[j],
                  dbn: block.dbn,
                  value: value.set
                })
              }
            } else if (columnNames[j] === 'status') {
              if (statusConfig.goodToStatus.some(function (element) { return element == value.set })) {
                continue
              } else if (statusConfig.errorToStatus.some(function (element) { return element == value.set })) {
                // error
                warnings.push({
                  msg: 'INCOMPATIBLE STATUS',
                  col: columnNames[j],
                  dbn: block.dbn,
                  value: value.set
                })
              } else {
                // warning
                warnings.push({
                  msg: 'UNEXPECTED STATUS',
                  col: columnNames[j],
                  dbn: block.dbn,
                  value: value.set
                })
              }
            }
          }
        }
        return warnings
      }
      function showWarnings (warnings, data) {
        // console.log(data)
        let warningMsg = '(WARNING) Some of the data is not as expected:\n'
        for (const warn of warnings) {
          warningMsg += 'DBN ' + warn.dbn + ', column "' + warn.col +
            '": (warning) for value "' + warn.value + '", ' + warn.msg + '\n'
        }
        warningMsg += 'Are you sure you want to submit this data to the database?'
        const bool = confirm(warningMsg)
        if (bool) {
          $('#' + selectedSection).css('display', 'none')
          $('#submittingData').css('display', 'block')
          google.script.run.withSuccessHandler(onSubmitDataSuccess).withFailureHandler(onFailure).setBlockData(data)
        }
      }
    
      function showErrorAlert (msg, data) {
        if (msg.unexpectedDBNError !== undefined) {
          const errorMsg = '(ERROR) Encountered an unexpected DBN (did a DBN change? were rows added or deleted?):\n' +
            'In sheet ' + sheetNames[msg.unexpectedDBNError.loc.sheet] + ', row ' + msg.unexpectedDBNError.loc.row +
            ', expected DBN ' + msg.unexpectedDBNError.expectedDBN + ', but found DBN ' + msg.unexpectedDBNError.foundDBN + '\n' +
            'Try refreshing the database and resubmitting (or Mason needs to fix something)'
          $('#' + selectedSection).css('display', 'block')
          $('#submittingData').css('display', 'none')
          alert(errorMsg)
        } else if (msg.dataValidationErrors.length !== 0 || msg.unexpectedValueErrors.length !== 0) {
          let errorMsg = ''
          const fatalErrors = []
          for (const error of msg.dataValidationErrors) {
            if (error.fatal) {
              fatalErrors.push(error)
            }
          }
          if (fatalErrors.length !== 0) {
            // show an alert: UNABLE to submit this data because these errors (the fatal errors)
            errorMsg += '(ERROR) Unable to submit data to the database due to these data validation errors:\n'
            for (const error of fatalErrors) {
              const dbn = blocksCollection.getBlockByLocation(error.loc.sheet, error.loc.row).dbn
              if (error.type === 'VALUE_IN_LIST') {
                errorMsg += 'In sheet ' + sheetNames[error.loc.sheet] + ', DBN ' + dbn +
                  ' (row ' + error.loc.row + '), column "' + (headers[error.loc.sheet][error.loc.col]) +
                  '": tried to write value "' + error.value + '" but cell requires a value in ' + JSON.stringify(error.args[0]) + '\n'
              } else if (error.type === 'DATE_IS_VALID_DATE') {
                errorMsg += 'In sheet ' + sheetNames[error.loc.sheet] + ', DBN ' + dbn +
                  ' (row ' + error.loc.row + '), column "' + (headers[error.loc.sheet][error.loc.col]) +
                  '": tried to write value "' + error.value + '" but cell requires a valid date\n'
              } else {
                errorMsg += 'In sheet ' + sheetNames[error.loc.sheet] + ', DBN ' + dbn +
                  ' (row ' + error.loc.row + '), column "' + (headers[error.loc.sheet][error.loc.col]) +
                  '": unknown data validation type (' + error.type + ') at value "' + error.value + '": ' + JSON.stringify(error.args[0]) + '\n'
                errorMsg += JSON.stringify(error) + '\n'
              }
            }
            $('#' + selectedSection).css('display', 'block')
            $('#submittingData').css('display', 'none')
            alert(errorMsg)
          } else {
            // no fatal errors, show warnings and ask to confirm
            if (msg.dataValidationErrors.length !== 0) {
              errorMsg += '(WARNING) Encountered the following unchecked data validation warnings while trying to write to the database:\n'
              for (const error of msg.dataValidationErrors) {
                const dbn = blocksCollection.getBlockByLocation(error.loc.sheet, error.loc.row).dbn
                if (error.type === 'VALUE_IN_LIST') {
                  errorMsg += 'In sheet ' + sheetNames[error.loc.sheet] + ', DBN ' + dbn +
                    ' (row ' + error.loc.row + '), column "' + (headers[error.loc.sheet][error.loc.col]) +
                    '": tried to write value "' + error.value + '" but cell suggests a value in ' + JSON.stringify(error.args[0]) + '\n'
                } else if (error.type === 'DATE_IS_VALID_DATE') {
                  errorMsg += 'In sheet ' + sheetNames[error.loc.sheet] + ', DBN ' + dbn +
                    ' (row ' + error.loc.row + '), column "' + (headers[error.loc.sheet][error.loc.col]) +
                    '": tried to write value "' + error.value + '" but cell suggests a valid date\n'
                } else {
                  errorMsg += 'In sheet ' + sheetNames[error.loc.sheet] + ', DBN ' + dbn +
                    ' (row ' + error.loc.row + '), column "' + (headers[error.loc.sheet][error.loc.col]) +
                    '": encountered an unknown data validation type (' + error.type + ') for value "' + error.value + '": ' + JSON.stringify(error.args[0]) + '\n'
                  errorMsg += JSON.stringify(error) + '\n'
                }
              }
            }
            if (msg.unexpectedValueErrors.length !== 0) {
              errorMsg += '(WARNING) Found the following unexpected values in the database (did these cells change since this page was loaded?):\n'
              for (const error of msg.unexpectedValueErrors) {
                const dbn = blocksCollection.getBlockByLocation(error.loc.sheet, error.loc.row).dbn
                errorMsg += 'In sheet ' + sheetNames[error.loc.sheet] + ', DBN ' + dbn +
                  ' (row ' + error.loc.row + '), column "' + (headers[error.loc.sheet][error.loc.col]) +
                  '": expected value "' + error.expected + '" but found "' + error.found + '"\n'
              }
            }
            errorMsg += 'Press OK to ignore these errors and submit this data to the database'
            const bool = confirm(errorMsg)
            if (bool) {
              for (const error of msg.dataValidationErrors.concat(msg.unexpectedValueErrors)) {
                const i = error.id[0]
                const j = error.id[1]
                data[i].values[j].ignoreError = true
              }
              google.script.run.withSuccessHandler(onSubmitDataSuccess).withFailureHandler(onFailure).setBlockData(data)
            } else {
              $('#' + selectedSection).css('display', 'block')
              $('#submittingData').css('display', 'none')
            }
          }
        } else {
          $('#' + selectedSection).css('display', 'block')
          $('#submittingData').css('display', 'none')
          const successMsg = 'Successfully wrote data to the database'
          alert(successMsg)
        }
      }
      function onSubmitDataSuccess (msg) {
        // console.log(msg)
        showErrorAlert(msg, data)
        updateBlocks(msg.newBlockData)
      }
      function onFailure (err) {
        alert('The server encountered an uncaught error while submitting data:\n' + JSON.stringify(err))
        throw err
      }
    }
    
    function updateDatabase () {
      const start = Date.now()
      document.getElementById('loadingDatabase').style.display = 'block'
      $('.hideWhenLoading').css('display', 'none')
      // console.log([$('#sectionSelection').css('display'), $('#tungstenSection').css('display'), $('#epoxySection').css('display'), $('#densitySection').css('display')])
      google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).getDatabase()
      function onSuccess (sheets) {
        lastDatabaseLoad = new Date()
        console.log('loaded database in ' + (Date.now() - start) / 1000 + ' s')
        updateTimestamp()
        database = [sheets.sheet1, sheets.sheet2]
        const blocks = []
        headers[0] = database[0][0]
        for (let i = 1; i < database[0].length; i++) {
          if (database[0][i][columns.block] !== '' && !isNaN(database[0][i][columns.block])) {
            blocks.push(new Block(database[0][i], 0, i + 1, blocks.length))
          }
        }
        headers[1] = database[1][0]
        for (let i = 1; i < database[1].length; i++) {
          if (database[1][i][columns.block] !== '' && !isNaN(database[1][i][columns.block])) {
            blocks.push(new Block(database[1][i], 1, i + 1, blocks.length))
          }
        }
        blocksCollection = new BlocksCollection(blocks)
        document.getElementById('loadingDatabase').style.display = 'none'
        $('#' + selectedSection).css('display', 'block')
        updateTables()
      }
      function onFailure (err) {
        alert('The server encountered an uncaught error while refreshing database:\n' + JSON.stringify(err))
        throw err
      }
    }
    function updateBlocks (blockData) {
      if (blockData != null) {
        const rowData = blockData.rowData
        const sheets = blockData.sheets
        const rows = blockData.rows
        for (let i = 0; i < rowData.length; i++) {
          blocksCollection.updateBlock(rowData[i], sheets[i], rows[i])
        }
        updateTables()
        // console.log('tried to update tables')
      }
    }
    function updateTables () {
      // console.log('updated tables?')
      // call all keyups? ig
      // ig DBN keyup should change everything necessary, so just call that?
      const allRows = []
      for (const settings of allSettings) {
        for (const row of settings.rows) {
          $(row).find("input[data-name='dbn']").keyup()
        }
      }
    }
    function updateTimestamp () {
      // (re)set color/style to the normal
      const timestampDiv = $('#timestamp')
      const text = 'Database loaded: ' + String(lastDatabaseLoad)
      const p = timestampDiv.children('p')
      // console.log(p)
      p.html(text).css('color', 'black').css('font-weight', 'normal')
      window.clearTimeout(reloadDatabaseTimer)
      reloadDatabaseTimer = window.setTimeout(setRed, 5 * 1000 * 60)
      function setRed () {
        p.css('color', 'red').css('font-weight', 'bold')
        alert('The script is using data which is at least 5 minutes old. Consider refreshing the database.')
      }
    }
  </script>
</html>
